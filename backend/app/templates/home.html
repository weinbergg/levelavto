{% extends "base.html" %} {% block title %}Level Avto ‚Äî –ê–≤—Ç–æ –∏–∑ –ï–≤—Ä–æ–ø—ã –ø–æ–¥
–∑–∞–∫–∞–∑{% endblock %} {% block head_extra %}
<link rel="stylesheet" href="/static/css/home.css?v=7" />
{% if hero_videos and hero_videos|length > 0 %}
<link rel="preload" as="video" href="{{ hero_videos[0] }}" fetchpriority="high" />
{% endif %}
{% endblock %} {% block content %}
<section class="hero hero-with-video" id="hero">
  {% if hero_videos %}
  <div class="hero-video" id="hero-video">
    <video
      id="hero-video-el"
      class="hero-video__el"
      playsinline
      muted
      loop
      autoplay
      preload="auto"
      src="{{ hero_videos[0] }}"
      poster="{{ collage_images[0].src if collage_images else '' }}"
    ></video>
    <div class="hero-video__overlay"></div>
  </div>
  {% endif %}

  <div class="la-container hero-search">
    <div class="search-card search-card--overlay">
      <div class="search-head">
        <h3 style="margin: 0">{{ home.search.title }}</h3>
        <p class="search-count">
          <span id="home-count-top" data-count="{{ total_cars }}">{{ total_cars }}</span>
          {{ home.search.subtitle_suffix }}
        </p>
      </div>
      <form class="search-form" id="home-search" method="get" action="/catalog">
        <div class="filter-grid filter-grid--overlay">
          <div class="field">
            <label for="home-brand">–ú–∞—Ä–∫–∞</label>
            <select id="home-brand" name="brand">
              <option value="">–í—Å–µ</option>
              {% for b in brands|sort %}
              <option value="{{ b }}">{{ b }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label for="home-model">–ú–æ–¥–µ–ª—å</label>
            <select id="home-model" name="model" disabled>
              <option value="">–í—Å–µ</option>
            </select>
          </div>
          <div class="field">
            <label for="home-country">–°—Ç—Ä–∞–Ω–∞</label>
            <select id="home-country" name="country">
              <option value="">–í—Å–µ</option>
              <option value="KR">–ö–æ—Ä–µ—è</option>
              {% for c in countries %}
              <option value="{{ c }}">{{ country_labels.get(c, c) }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label for="home-price-min">–¶–µ–Ω–∞ –æ—Ç, ‚ÇΩ</label>
            <input
              id="home-price-min"
              name="price_min"
              type="number"
              inputmode="numeric"
              min="0"
              step="1000"
            />
          </div>
          <div class="field">
            <label for="home-price-max">–¶–µ–Ω–∞ –¥–æ, ‚ÇΩ</label>
            <input
              id="home-price-max"
              name="price_max"
              type="number"
              inputmode="numeric"
              min="0"
              step="1000"
            />
          </div>
          <div class="field">
            <label for="home-reg-year">–ü–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ —É—á—ë—Ç —Å (–≥–æ–¥)</label>
            <select id="home-reg-year" name="reg_year_min">
              <option value="">–ù–µ –≤–∞–∂–Ω–æ</option>
              {% for y in reg_years %}
              <option value="{{ y }}">{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label for="home-reg-month">–ü–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ —É—á—ë—Ç —Å (–º–µ—Å—è—Ü)</label>
            <select id="home-reg-month" name="reg_month_min">
              <option value="">–ù–µ –≤–∞–∂–Ω–æ</option>
              {% for m in reg_months %}
              <option value="{{ m.value }}">{{ m.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label for="home-mileage-min">–ü—Ä–æ–±–µ–≥ –æ—Ç, –∫–º</label>
            <input
              id="home-mileage-min"
              name="mileage_min"
              type="number"
              inputmode="numeric"
              min="0"
              step="1"
            />
          </div>
          <div class="field">
            <label for="home-mileage-max">–ü—Ä–æ–±–µ–≥ –¥–æ, –∫–º</label>
            <input
              id="home-mileage-max"
              name="mileage_max"
              type="number"
              inputmode="numeric"
              min="0"
              step="1"
            />
          </div>
          <div class="field">
            <label for="home-transmission">–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è</label>
            <select id="home-transmission" name="transmission">
              <option value="">–õ—é–±–∞—è</option>
              {% for t in transmissions %}
              <option value="{{ t.value }}">{{ t.label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="inline-actions">
          <button type="submit" class="btn btn-primary" id="home-submit">
            <span class="label">{{ home.search.submit_label }}</span>
            <span class="sep">¬∑</span>
            <span id="home-count" data-count="{{ total_cars }}">{{ total_cars }}</span>
            <span class="suffix">{{ home.search.submit_suffix }}</span>
          </button>
          <div class="links">
            <a href="#" id="home-reset">{{ home.search.reset_label }}</a>
            <a href="/search">{{ home.search.catalog_label }}</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="la-container hero-grid">
    <div class="hero-text">
      <div class="stats-badge">{{ total_cars }} {{ home.hero.stats_suffix }}</div>
      <h1>{{ home.hero.title }}</h1>
      <p class="subtitle">{{ home.hero.subtitle }}</p>
      <div class="benefits">
        {% set benefit_icons = ["üí≥", "‚è±Ô∏è", "üìë"] %}
        {% for item in home.hero.benefits %}
        <div class="benefit">
          <span class="icon">{{ benefit_icons[loop.index0] }}</span>{{ item }}
        </div>
        {% endfor %}
      </div>
      <div class="hero-actions">
        <a class="btn btn-primary" href="/catalog">{{ home.hero.actions.primary_label }}</a>
        <a class="btn btn-secondary" href="#lead-form">{{ home.hero.actions.secondary_label }}</a>
      </div>
      <div class="hero-note">{{ home.hero.note }}</div>
    </div>
    <div class="hero-visual">
      <div class="card" style="padding: 18px">
        <h3 style="margin-top: 0">{{ home.hero.why_title }}</h3>
        <ul class="specs">
          {% for item in home.hero.why_items %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</section>
<section class="section" id="cases">
  <div class="la-container">
    <div class="section-header">
      <div>
        <h2 class="section-title">{{ home.cases.title }}</h2>
        <p class="section-sub">{{ home.cases.subtitle }}</p>
      </div>
    </div>
  </div>
  <div class="collage-wrap">
    {% set visible = collage_images[:60] %}
    {% set hidden = collage_images[60:] %}
    <div class="collage-track" id="collage-track">
      {% for img in visible %}
      <div class="collage-item">
        <img
          src="{{ img.src }}"
          srcset="{{ img.srcset }}"
          sizes="(max-width: 768px) 45vw, 240px"
          alt="–ê–≤—Ç–æ –∫–µ–π—Å"
          loading="lazy"
          decoding="async"
          fetchpriority="low"
          width="{{ img.width }}"
          height="{{ img.height }}"
          onerror="this.onerror=null; this.src='{{ img.fallback }}'; this.srcset='';"
        />
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<section class="section section--about" id="about">
  <div class="la-container">
    <div class="about-header">
      <p class="eyebrow">{{ home.about.eyebrow }}</p>
      <h2 class="section-title">{{ home.about.title }}</h2>
      <p class="section-sub">{{ home.about.subtitle }}</p>
    </div>
    {% set about_cards = home.about.cards %}
    <div class="about-cards">
      <div class="about-card">
        <h3 class="about-subtitle">{{ about_cards[0].title }}</h3>
        <ul class="specs">
          {% for item in about_cards[0]['items'] %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>
      <div class="about-card">
        <h3 class="about-subtitle">{{ about_cards[1].title }}</h3>
        <ul class="specs">
          {% for item in about_cards[1]['items'] %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>
      <div class="about-card">
        <h3 class="about-subtitle">{{ about_cards[2].title }}</h3>
        <ul class="specs">
          {% for item in about_cards[2]['items'] %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>
      <div class="about-card">
        <h3 class="about-subtitle">{{ about_cards[3].title }}</h3>
        <ul class="specs">
          {% for item in about_cards[3]['items'] %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
        <p>{{ about_cards[3].paragraph }}</p>
        <p><strong>{{ about_cards[3].emphasis }}</strong></p>
      </div>
    </div>
  </div>
</section>

<section class="section" id="recommended">
  <div class="la-container">
    <div class="section-header">
      <div>
        <h2 class="section-title">{{ home.recommended.title }}</h2>
        <p class="section-sub">{{ home.recommended.subtitle }}</p>
      </div>
    </div>
    <div class="cards cards-highlights">
      {% for car in recommended_cars %}
      <a class="card car-card" href="/car/{{ car.id }}">
        <div class="thumb-wrap">
          <span class="badge-tag badge-tag--alt">{{ home.recommended.badge_label }}</span>
          <img
            class="thumb"
            src="{{ car.thumbnail_url or '' }}"
            width="320"
            height="200"
            alt=""
            loading="lazy"
            decoding="async"
          />
        </div>
        <div class="car-card__body">
          <div>
            <div class="car-card__title">
              {{ car.brand or '' }} {{ car.model or '' }}
            </div>
            <div class="car-card__meta">
              {{ car.year or '' }} ¬∑ {{ car.display_engine_type or car.engine_type or '' }} ¬∑ {{
              car.display_transmission or car.transmission or '' }}
            </div>
            <ul class="specs">
              <li>–ü—Ä–æ–±–µ–≥: {{ car.mileage or '‚Äî' }}</li>
              <li>–ö—É–∑–æ–≤: {{ car.body_type or '‚Äî' }}</li>
              <li>–°—Ç—Ä–∞–Ω–∞: {{ car.display_country_label or car.country or '‚Äî' }}</li>
            </ul>
          </div>
          <div class="car-card__price">
            {% if car.price %} {% set rate = fx_rates.get((car.currency or
            'EUR').upper(), 1) | float %} {% set rub = (car.price | float *
            rate) | round(0, 'ceil') | int %}
            <span>{{ '{:,.0f}'.format(rub).replace(',', ' ') }} ‚ÇΩ</span>
            {% endif %}
          </div>
        </div>
      </a>
      {% else %}
      <p class="hero-note">{{ home.recommended.empty_note }}</p>
      {% endfor %}
    </div>
  </div>
</section>

<section class="section" id="vehicle-types">
  <div class="la-container">
    <div class="section-header">
      <div>
        <h2 class="section-title">{{ home.vehicle_types.title }}</h2>
        <p class="section-sub">{{ home.vehicle_types.subtitle }}</p>
      </div>
    </div>
    {% set labels = {
      'wagon':'–£–Ω–∏–≤–µ—Ä—Å–∞–ª',
      'sedan':'–°–µ–¥–∞–Ω',
      'cabrio':'–ö–∞–±—Ä–∏–æ–ª–µ—Ç',
      'convertible':'–ö–∞–±—Ä–∏–æ–ª–µ—Ç',
      'suv':'–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫',
      'hatchback':'–•—ç—Ç—á–±–µ–∫',
      'coupe':'–ö—É–ø–µ',
      'van':'–ú–∏–Ω–∏–≤—ç–Ω',
      'pickup':'–ü–∏–∫–∞–ø'
    } %}
    {% set icons = {
      'sedan':'<svg viewBox="0 0 28 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="3" y="7" width="16" height="6" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M7 7L9 4.5C9.2 4.2 9.6 4 10 4h6c0.4 0 0.8 0.2 1 0.5L18 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
      'hatchback':'<svg viewBox="0 0 28 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="3" y="7" width="16" height="6" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M6 7L10 4.5C10.3 4.3 10.6 4.2 11 4.2H16L18 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
      'wagon':'<svg viewBox="0 0 28 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="2.5" y="7" width="18" height="6" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M6 7L9 4.5C9.3 4.2 9.7 4 10.1 4H16.5L18.5 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="7.5" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
      'suv':'<svg viewBox="0 0 28 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="3" y="8" width="16" height="5.5" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M6.5 8L9 5.5C9.4 5.1 9.9 5 10.4 5h6.2c0.4 0 0.9 0.2 1.1 0.5L19 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8" cy="14.5" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="14.5" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
      'coupe':'<svg viewBox="0 0 28 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="4" y="8" width="15" height="5" rx="1.3" stroke="currentColor" stroke-width="1.5"/><path d="M8 8L12 5.5C12.3 5.3 12.6 5.2 13 5.2H16.5L18.5 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
      'convertible':'<svg viewBox="0 0 28 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="4" y="9" width="15" height="4" rx="1.2" stroke="currentColor" stroke-width="1.5"/><path d="M7 9L11 6.5C11.4 6.2 11.8 6 12.2 6H15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="9" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="14" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
      'pickup':'<svg viewBox=\"0 0 28 18\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\"><rect x=\"2.5\" y=\"9\" width=\"12\" height=\"4\" rx=\"1\" stroke=\"currentColor\" stroke-width=\"1.5\"/><path d=\"M14.5 9H20c0.6 0 1 0.4 1 1v3H14.5\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\"/><path d=\"M6.5 9L10 6.5C10.3 6.2 10.7 6 11.1 6H13.5\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\"/><circle cx=\"7.5\" cy=\"14\" r=\"2\" stroke=\"currentColor\" stroke-width=\"1.5\"/><circle cx=\"17.5\" cy=\"14\" r=\"2\" stroke=\"currentColor\" stroke-width=\"1.5\"/></svg>',
      'van':'<svg viewBox=\"0 0 28 18\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\"><rect x=\"3\" y=\"8\" width=\"17\" height=\"5.5\" rx=\"1.5\" stroke=\"currentColor\" stroke-width=\"1.5\"/><path d=\"M6 8L12 5.5C12.4 5.3 12.8 5.2 13.2 5.2H17.5L19.5 8\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/><circle cx=\"8\" cy=\"14.5\" r=\"2\" stroke=\"currentColor\" stroke-width=\"1.5\"/><circle cx=\"17.5\" cy=\"14.5\" r=\"2\" stroke=\"currentColor\" stroke-width=\"1.5\"/></svg>',
      'default':'<svg viewBox=\"0 0 28 18\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\"><rect x=\"3\" y=\"7\" width=\"16\" height=\"6\" rx=\"1.5\" stroke=\"currentColor\" stroke-width=\"1.5\"/><path d=\"M7 7L9 4.5C9.2 4.2 9.6 4 10 4h6c0.4 0 0.8 0.2 1 0.5L18 7\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/><circle cx=\"8\" cy=\"14\" r=\"2\" stroke=\"currentColor\" stroke-width=\"1.5\"/><circle cx=\"17\" cy=\"14\" r=\"2\" stroke=\"currentColor\" stroke-width=\"1.5\"/></svg>'
    } %}
    <div class="vehicle-grid">
      {% for item in body_type_stats[:8] %}
      <a class="vehicle-card" href="/catalog?body_type={{ item.body_type }}">
        <div class="vehicle-title">{{ labels.get(item.body_type, item.body_type) }}</div>
        <div class="muted small">–û–±—ä—è–≤–ª–µ–Ω–∏–π: {{ item.count }}</div>
      </a>
      {% else %}
      <p class="hero-note">{{ home.vehicle_types.empty_note }}</p>
      {% endfor %}
    </div>
  </div>
</section>

<section class="section" id="advantages">
  <div class="la-container">
    <div class="section-header">
      <div>
        <h2 class="section-title">{{ home.advantages.title }}</h2>
        <p class="section-sub">{{ home.advantages.subtitle }}</p>
      </div>
    </div>
    <div class="category-grid">
      <div class="card">
        <strong>{{ home.advantages.cards[0].title }}</strong>
        <p class="hero-note">{{ home.advantages.cards[0].text }}</p>
      </div>
      <div class="card">
        <strong>{{ home.advantages.cards[1].title }}</strong>
        <p class="hero-note">{{ home.advantages.cards[1].text }}</p>
      </div>
      <div class="card">
        <strong>{{ home.advantages.cards[2].title }}</strong>
        <p class="hero-note">{{ home.advantages.cards[2].text }}</p>
      </div>
    </div>
  </div>

  <section class="section" id="brands">
    <div class="la-container">
      <div class="section-header">
        <div>
          <h2 class="section-title">{{ home.brands.title }}</h2>
          <p class="section-sub">{{ home.brands.subtitle }}</p>
        </div>
      </div>
      {% set primary = brand_logos[:12] %} {% set primary_names = primary |
      map(attribute='brand') | list %} {% set others = brand_stats[0:60] %}
      <div class="brand-logo-grid">
        {% for item in primary %}
        <a class="brand-logo-tile" href="/catalog?brand={{ item.brand }}">
          <div class="brand-logo-thumb">
            <img src="{{ item.logo }}" alt="{{ item.brand }}" loading="lazy" />
          </div>
          <div class="brand-logo-meta">
            <strong>{{ item.brand }}</strong>
            <span class="small">{{ item.count }} –∞–≤—Ç–æ</span>
          </div>
        </a>
        {% else %}
        <p class="hero-note">{{ home.brands.empty_note }}</p>
        {% endfor %}
      </div>
    </div>
  </section>


  <section class="section" id="how-it-works">
    <div class="la-container">
      <div class="section-header">
        <div>
          <h2 class="section-title">{{ home.how_it_works.title }}</h2>
          <p class="section-sub">{{ home.how_it_works.subtitle }}</p>
        </div>
      </div>
      <div class="how-steps">
        <div class="how-step">
          <div class="how-step__badge">1</div>
          <div>
            <strong>{{ home.how_it_works.steps[0].title }}</strong>
            <p>{{ home.how_it_works.steps[0].text }}</p>
          </div>
        </div>
        <div class="how-step">
          <div class="how-step__badge">2</div>
          <div>
            <strong>{{ home.how_it_works.steps[1].title }}</strong>
            <p>{{ home.how_it_works.steps[1].text }}</p>
          </div>
        </div>
        <div class="how-step">
          <div class="how-step__badge">3</div>
          <div>
            <strong>{{ home.how_it_works.steps[2].title }}</strong>
            <p>{{ home.how_it_works.steps[2].text }}</p>
          </div>
        </div>
        <div class="how-step">
          <div class="how-step__badge">4</div>
          <div>
            <strong>{{ home.how_it_works.steps[3].title }}</strong>
            <p>{{ home.how_it_works.steps[3].text }}</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="seo">
    <div class="la-container">
      <div class="seo-block">
        <h2 class="section-title" style="margin: 0">
          {{ home.seo.title }}
        </h2>
        <p>{{ home.seo.paragraphs[0] }}</p>
        <p>{{ home.seo.paragraphs[1] }}</p>
        <p>{{ home.seo.paragraphs[2] }}</p>
      </div>
    </div>
  </section>

  <section class="lead-section" id="lead-form">
    <div class="la-container">
      <div class="section-header">
        <div>
          <h2 class="section-title">{{ home.lead.title }}</h2>
          <p class="section-sub">{{ home.lead.subtitle }}</p>
        </div>
      </div>
      <div class="lead-card">
        <form method="post" action="/lead" class="form lead-form-grid">
          <div class="form-grid form-grid--12">
            <div class="field span-4">
              <label for="lead-name">–ò–º—è*</label>
              <input
                id="lead-name"
                name="name"
                required
                placeholder="–ê–ª–µ–∫—Å–µ–π"
                value="{{ user.full_name if user else '' }}"
              />
            </div>
            <div class="field span-4">
              <label for="lead-phone">–¢–µ–ª–µ—Ñ–æ–Ω*</label>
              <input
                id="lead-phone"
                name="phone"
                required
                placeholder="+7 (911) 070-75-00"
                value="{{ user.phone if user and user.phone is defined else '' }}"
              />
            </div>
            <div class="field span-4">
              <label for="lead-email">Email</label>
              <input
                id="lead-email"
                name="email"
                type="email"
                placeholder="you@example.com"
                value="{{ user.email if user else '' }}"
              />
            </div>
            <div class="field span-6">
              <label for="lead-preferred"
                >–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è –º–∞—Ä–∫–∞/–º–æ–¥–µ–ª—å</label
              >
              <input
                id="lead-preferred"
                name="preferred"
                placeholder="BMW 5, Audi Q5"
              />
            </div>
            <div class="field span-6">
              <label for="lead-price">–î–∏–∞–ø–∞–∑–æ–Ω –±—é–¥–∂–µ—Ç–∞</label>
              <input
                id="lead-price"
                name="price_range"
                placeholder="–æ—Ç 2 –º–ª–Ω ‚ÇΩ"
              />
            </div>
            <div class="field span-12">
              <label for="lead-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
              <textarea
                id="lead-comment"
                name="comment"
                placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω—É–∂–µ–Ω –∏ –∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–∫—É–ø–∞—Ç—å"
              ></textarea>
            </div>
            <div class="field span-12 consent-field">
              <label class="checkbox">
                <input type="checkbox" name="privacy" required />
                <span>
                  {{ home.lead.privacy_prefix }}
                  <a href="/privacy" target="_blank" rel="noopener"
                    >{{ home.lead.privacy_link_text }}</a
                  >
                </span>
              </label>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                {{ home.lead.submit_label }}
              </button>
              <span class="hero-note"
                >{{ home.lead.note }}</span
              >
            </div>
          </div>
          {% if lead_status %}
          <div
            class="form-status {{ 'success' if lead_status.success else 'error' }}"
          >
            {{ lead_status.message }}
          </div>
          {% endif %}
        </form>
      </div>
    </div>
  </section>

  <section class="section" id="contacts">
    <div class="la-container">
      <div class="section-header">
        <div>
          <h2 class="section-title">{{ home.contacts.title }}</h2>
          {% set phone = contact_phone or content.get('contact_phone','+7 (911) 070-75-00') %}
          {% set email = contact_email or content.get('contact_email','info@levelavto.ru') %}
          {% set address = contact_address or content.get('contact_address','–®–µ–ª–µ–ø–∏—Ö–∏–Ω—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 34–∫4 —Å—Ç—Ä.8, –ú–æ—Å–∫–≤–∞') %}
          <p class="section-sub">{{ address }}. {{ home.contacts.subtitle_suffix }}</p>
        </div>
      </div>
      <div class="contact-map">
        <div class="contact-card">
          <h3><a href="tel:{{ phone|replace(' ','') }}">{{ phone }}</a></h3>
          <p class="hero-note">
            {{ home.contacts.callback_label }} ¬∑
            {% if contact_tg or content.get('contact_tg') %}
            <a href="{{ contact_tg or content.get('contact_tg') }}" target="_blank" rel="noopener">Telegram</a>
            {% endif %}
            {% if contact_wa or content.get('contact_wa') %}
            ¬∑ <a href="{{ contact_wa or content.get('contact_wa') }}" target="_blank" rel="noopener">WhatsApp</a>
            {% endif %}
            {% if contact_ig or content.get('contact_ig') %}
            ¬∑ <a href="{{ contact_ig or content.get('contact_ig') }}" target="_blank" rel="noopener">Instagram</a>
            {% endif %}
          </p>
          <p class="muted">{{ address }}</p>
          <p class="muted">{{ home.contacts.hours_note }}</p>
          <div class="inline-actions" style="margin-top: 10px">
            <a class="btn btn-primary" href="tel:{{ phone|replace(' ','') }}">{{ home.contacts.call_button }}</a>
            <a class="btn btn-secondary" href="mailto:{{ email }}">{{ home.contacts.email_button }}</a>
          </div>
        </div>
        <iframe
          src="https://yandex.ru/map-widget/v1/?ll=37.5209%2C55.7540&z=15&pt=37.5209,55.7540,pm2rdl"
          width="100%"
          height="380"
          frameborder="0"
          style="border: 0; border-radius: 16px; overflow: hidden"
          allowfullscreen
        ></iframe>
      </div>
    </div>
  </section>
  <script>
    (() => {
      const videoEl = document.getElementById("hero-video-el");
      if (videoEl) {
        videoEl.muted = true;
        videoEl.setAttribute("muted", "");
        videoEl.playsInline = true;
        videoEl.setAttribute("playsinline", "");
        videoEl.controls = false;
        videoEl.removeAttribute("controls");
        const tryPlay = () => {
          if (document.hidden) return;
          const p = videoEl.play();
          if (p && typeof p.catch === "function") {
            p.catch(() => {});
          }
        };
        videoEl.addEventListener("canplay", tryPlay, { once: true });
        requestAnimationFrame(tryPlay);
        setTimeout(tryPlay, 400);
        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) {
            tryPlay();
          }
        });
      }

      const form = document.getElementById("mini-calc-form");
      if (!form) return;
      const modeSelect = document.getElementById("mini-mode");
      const scenarioSelect = document.getElementById("mini-scenario");
    const blockEngine = form.querySelector('[data-block="engine"]');
    const blockPower = form.querySelector('[data-block="power"]');
      const resultWrap = document.getElementById("mini-calc-result");
      const resultTotal = document.getElementById("mini-calc-total");
      const resultList = document.getElementById("mini-calc-breakdown");
      const warn = document.getElementById("mini-warn");
      const submitBtn = form.querySelector("button[type='submit']");

      const fmt = (num) =>
        Number(num).toLocaleString("ru-RU", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      const ageBucket = (y, m) => {
        if (!y || !m) return null;
        const d = new Date(y, m - 1, 1);
        const now = new Date();
        const months = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
        if (months < 36) return "under_3";
        if (months <= 60) return "3_5";
        return "too_old";
      };

      const updateVisibility = () => {
        const mode = modeSelect.value;
        const s = scenarioSelect.value;
        if (mode === "manual") {
          scenarioSelect.disabled = false;
          blockEngine.style.display = s === "electric" ? "none" : "";
          blockPower.style.display = s === "electric" ? "" : "none";
          warn.style.display = "none";
          submitBtn.disabled = false;
          return;
        }
        // auto mode
        scenarioSelect.disabled = true;
        const regY = Number(document.getElementById("mini-reg-year").value) || null;
        const regM = Number(document.getElementById("mini-reg-month").value) || null;
        const isElectric = document.getElementById("mini-is-electric").value === "1";
        const cc = Number(document.getElementById("mini-engine").value) || null;
        const hp = Number(document.getElementById("mini-power").value) || null;
        const price = Number(document.getElementById("mini-price").value) || null;
        const bucket = ageBucket(regY, regM);
        let autoScenario = "";
        if (bucket === "too_old") {
          warn.style.display = "";
          warn.querySelector(".hero-note").textContent = "–ê–≤—Ç–æ —Å—Ç–∞—Ä—à–µ 5 –ª–µ—Ç ‚Äî —Ä–∞—Å—á—ë—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É.";
          submitBtn.disabled = true;
        } else {
          warn.style.display = "none";
          submitBtn.disabled = false;
        }
        if (isElectric) {
          autoScenario = "electric";
        } else if (bucket === "under_3") {
          autoScenario = "under_3";
        } else if (bucket === "3_5") {
          autoScenario = "3_5";
        }
        scenarioSelect.value = autoScenario;
        blockEngine.style.display = isElectric ? "none" : "";
        blockPower.style.display = isElectric ? "" : "none";
        const hasData =
          price &&
          regY &&
          regM &&
          (isElectric ? hp : cc) &&
          bucket !== "too_old" &&
          autoScenario;
        if (!hasData) {
          submitBtn.disabled = true;
          warn.style.display = "";
          warn.querySelector(".hero-note").textContent =
            "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏. –û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É.";
        }
      };
      scenarioSelect.addEventListener("change", updateVisibility);
      updateVisibility();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (submitBtn.disabled) return;
        const payload = {
          scenario: modeSelect.value === "manual" ? scenarioSelect.value : scenarioSelect.value,
          price_net_eur: Number(document.getElementById("mini-price").value),
          engine_cc:
            Number(document.getElementById("mini-engine").value) || undefined,
          power_hp:
            Number(document.getElementById("mini-power").value) || undefined,
        first_registration_year:
          Number(document.getElementById("mini-reg-year").value) || undefined,
        first_registration_month:
          Number(document.getElementById("mini-reg-month").value) || undefined,
        is_electric: document.getElementById("mini-is-electric").value === "1",
        };
        const resp = await fetch("/api/calc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          alert(err.detail || "–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞");
          return;
        }
        const res = await resp.json();
        resultTotal.textContent = fmt(res.total_rub) + " ‚ÇΩ";
        resultList.innerHTML = "";
        (res.breakdown || []).slice(0, 8).forEach((item) => {
          const row = document.createElement("div");
          row.className = "calc-row";
          row.innerHTML = `<div>${item.title}</div><div>${fmt(item.amount)} ${
            item.currency
          }</div>`;
          resultList.appendChild(row);
        });
        resultWrap.style.display = "";
      });

      // Prefill from query params
      (() => {
        const params = new URLSearchParams(window.location.search);
        const setVal = (id, key) => {
          const el = document.getElementById(id);
          if (el && params.get(key)) el.value = params.get(key);
        };
        setVal("mini-price", "price");
        setVal("mini-engine", "engine_cc");
        setVal("mini-power", "power_hp");
        setVal("mini-reg-year", "reg_year");
        setVal("mini-reg-month", "reg_month");
        if (params.get("is_electric") === "1") {
          document.getElementById("mini-is-electric").value = "1";
          scenarioSelect.value = "electric";
          modeSelect.value = "auto";
        }
        updateVisibility();
      })();

      // Collage animation only when visible
      // collage now static (no autoscroll)
    })();
  </script>
  {% endblock %}
