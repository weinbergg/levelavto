{% extends "base.html" %} {% block title %}Авто — {{ car.brand }} {{ car.model
}}{% endblock %} {% block content %}
<section class="car-detail-page">
  <div class="la-container">
    {% if not car %}
    <div class="card">Автомобиль не найден.</div>
    {% else %}
    <div style="margin-bottom:12px;">
      <a id="back-to-catalog" class="btn btn-ghost btn-small" href="/catalog" style="display:none;">← Назад в каталог</a>
    </div>
    <div class="detail-hero">
      <div class="detail-gallery card">
        {% set image_urls = detail_images if detail_images else [] %}
        {% set primary = image_urls[0] if image_urls and image_urls|length > 0 else car.thumbnail_url %}
        {% set primary_raw = (primary or '')|trim %}
        {% if not primary_raw %}
          {% set primary_src = '/static/img/no-photo.svg' %}
        {% elif 'img.classistatic.de' in primary_raw %}
          {% set primary_src = "/thumb?u=" ~ (primary_raw | urlencode) ~ "&w=1024&fmt=webp&rev=2" %}
        {% elif primary_raw.startswith('/api/v1/mo-prod/images/') %}
          {% set primary_src = "/thumb?u=" ~ (("https://img.classistatic.de" ~ primary_raw) | urlencode) ~ "&w=1024&fmt=webp&rev=2" %}
        {% elif primary_raw.startswith('api/v1/mo-prod/images/') %}
          {% set primary_src = "/thumb?u=" ~ (("https://img.classistatic.de/" ~ primary_raw) | urlencode) ~ "&w=1024&fmt=webp&rev=2" %}
        {% elif primary_raw.startswith('/media/') or primary_raw.startswith('https://') or primary_raw.startswith('http://') %}
          {% set primary_src = primary_raw %}
        {% elif primary_raw|length == 36 and primary_raw.count('-') == 4 %}
          {% set primary_src = "/thumb?u=" ~ (("https://img.classistatic.de/api/v1/mo-prod/images/" ~ primary_raw[:2] ~ "/" ~ primary_raw ~ "?rule=mo-1024.jpg") | urlencode) ~ "&w=1024&fmt=webp&rev=2" %}
        {% else %}
          {% set primary_src = '/static/img/no-photo.svg' %}
        {% endif %}
        <div class="detail-hero__main placeholder" data-images='{{ image_urls | tojson }}'>
          {% if primary %}
          <img
            id="primaryImage"
            src="{{ primary_src }}"
            alt="{{ car.brand }} {{ car.model }}"
            loading="eager"
            decoding="async"
            referrerpolicy="no-referrer"
            data-thumb="{{ primary_src or '' }}"
            data-orig="{{ primary or '' }}"
            width="960"
            height="640"
          />
          {% if image_urls and image_urls|length > 1 %}
          <button type="button" class="detail-nav detail-nav--prev" data-detail-prev aria-label="Предыдущее фото">‹</button>
          <button type="button" class="detail-nav detail-nav--next" data-detail-next aria-label="Следующее фото">›</button>
          {% endif %}
          {% else %}
          <div class="empty-placeholder">Нет фотографий</div>
          {% endif %}
        </div>
        {% if image_urls and image_urls|length > 1 %}
        <div class="detail-hero__thumbs">
          {% for img_url in image_urls[:30] %}
          {% set im_raw = (img_url or '')|trim %}
          {% if not im_raw %}
            {% set thumb_src = '/static/img/no-photo.svg' %}
          {% elif 'img.classistatic.de' in im_raw %}
            {% set thumb_src = "/thumb?u=" ~ (im_raw | urlencode) ~ "&w=240&fmt=webp&rev=2" %}
          {% elif im_raw.startswith('/api/v1/mo-prod/images/') %}
            {% set thumb_src = "/thumb?u=" ~ (("https://img.classistatic.de" ~ im_raw) | urlencode) ~ "&w=240&fmt=webp&rev=2" %}
          {% elif im_raw.startswith('api/v1/mo-prod/images/') %}
            {% set thumb_src = "/thumb?u=" ~ (("https://img.classistatic.de/" ~ im_raw) | urlencode) ~ "&w=240&fmt=webp&rev=2" %}
          {% elif im_raw.startswith('/media/') or im_raw.startswith('https://') or im_raw.startswith('http://') %}
            {% set thumb_src = im_raw %}
          {% elif im_raw|length == 36 and im_raw.count('-') == 4 %}
            {% set thumb_src = "/thumb?u=" ~ (("https://img.classistatic.de/api/v1/mo-prod/images/" ~ im_raw[:2] ~ "/" ~ im_raw ~ "?rule=mo-1024.jpg") | urlencode) ~ "&w=240&fmt=webp&rev=2" %}
          {% else %}
            {% set thumb_src = '/static/img/no-photo.svg' %}
          {% endif %}
          <button
            type="button"
            class="thumb"
            data-thumb-index="{{ loop.index0 }}"
          >
            <img
              src="{{ thumb_src }}"
              alt="thumb {{ loop.index }}"
              loading="lazy"
              decoding="async"
              referrerpolicy="no-referrer"
              data-orig="{{ im_raw }}"
              width="180"
              height="120"
            />
          </button>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      <div class="detail-info card">
        <div class="detail-heading">
          <h1 class="detail-title">{{ car.brand or '' }} {{ car.model or '' }}</h1>
          {% set meta = [] %} {% if car.year %}{% set _ = meta.append(car.year) %}{% endif %} {% if car.display_engine_type or car.engine_type %}{% set _ = meta.append(car.display_engine_type or car.engine_type) %}{% endif %}
          {% set gross = pricing.gross_eur if pricing else None %}
          {% set net = pricing.net_eur if pricing else None %}
          {% set vat_pct = pricing.vat_percent if pricing else None %}
          {% set vat_reclaim = pricing.vat_reclaimable if pricing else False %}
          {% set display_price = car.display_price_rub %}
          <div class="detail-price">
            <div class="detail-price__total">
              {% if display_price %}
                {% set display_price_round = ((display_price + 9999) // 10000) * 10000 %}
                {{ '{:,.0f}'.format(display_price_round).replace(',', ' ') }} ₽
              {% else %}
                —
              {% endif %}
            </div>
            <div class="detail-price__meta">
              {% if gross %}
              BRUTTO: {{ '{:,.0f}'.format(gross).replace(',', ' ') }} €
              {% elif car.price %}
              Цена: {{ '{:,.0f}'.format(car.price).replace(',', ' ') }} {{ car.currency or '' }}
              {% endif %}
              {% if net %}
              <br>NET: {{ '{:,.0f}'.format(net).replace(',', ' ') }} €
              {% endif %}
              {% if vat_pct is not none %}
              <br>НДС: {% if vat_reclaim %}возмещается ({{ vat_pct }}%){% else %}не возмещается{% endif %}
              {% endif %}
            </div>
            {% if car.price_note %}
            <div class="detail-price__note">{{ car.price_note }}</div>
            {% endif %}
          </div>
          {% if meta %}
          <p class="muted detail-meta">{{ meta|join(' · ') }}</p>
          {% endif %}
          <p class="muted">
            {% if car.display_country_label or car.country %}Страна: {{ car.display_country_label or car.country }} · {% endif %} Фото:
            {{ image_urls|length if image_urls else 0 }}
          </p>
          {% if user %}
          <button class="fav-btn" data-fav-button data-car-id="{{ car.id }}" aria-label="Добавить в избранное">★</button>
          {% endif %}
        </div>
        <div class="detail-specs">
          {% if car.mileage %}
          <div class="chip">Пробег: {{ car.mileage }}</div>
          {% endif %} {% if car.body_type %}
          <div class="chip">Кузов: {{ car.display_body_type or car.body_type }}</div>
          {% endif %} {% if car.drive_type %}
          <div class="chip">Привод: {{ car.drive_type }}</div>
          {% endif %} {% if car.color %}
          <div class="chip">Цвет: {{ car.display_color or car.color }}</div>
          {% endif %} {% if car.display_country_label or car.country %}
          <div class="chip">Страна: {{ car.display_country_label or car.country }}</div>
          {% endif %} {% if car.vin %}
          <div class="chip">VIN: {{ car.vin }}</div>
          {% endif %}
          {% if car.power_hp %}
          <div class="chip">Мощность: {{ car.power_hp }} л.с.</div>
          {% endif %}
          {% if car.engine_cc %}
          <div class="chip">Объём: {{ car.engine_cc }} см³</div>
          {% endif %}
        </div>
        {% if car_details and car_details|length > 0 %}
        <div class="detail-state card">
          <h3>Состояние авто</h3>
          <div class="detail-state__grid">
            {% for item in car_details %}
            <div class="detail-state__item">
              <span class="label">{{ item.label }}</span>
              <span class="value">{{ item.value }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        {% if car_options and car_options|length > 0 %}
        <div class="detail-options card">
          <h3>Оснащение</h3>
          <div class="detail-options__chips">
            {% for opt in car_options %}
            <div class="calc-chip">{{ opt }}</div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <div class="detail-actions">
          <div class="detail-actions__lead">
            <button class="btn cta-lead" id="detail-lead-btn" type="button" onclick="return window.toggleLeadForm(event);">
              Связаться
            </button>
          </div>
        </div>
        <div id="detail-lead-form" class="card" style="margin-top:12px; display:none;">
          <form method="post" action="/lead" class="form-grid form-grid--12 lead-form-grid">
            {% set title_line = (car.brand or '') ~ ' ' ~ (car.model or '') ~ (' ' ~ car.year if car.year else '') %}
            {% set price_line = '' %}
            {% if calc and calc.total_rub %}
              {% set price_line = '{:,.0f}'.format(calc.total_rub).replace(",", " ") ~ ' ₽ (итог в РФ)' %}
            {% elif pricing and pricing.gross_eur %}
              {% set price_line = '{:,.0f}'.format(pricing.gross_eur).replace(",", " ") ~ ' € (BRUTTO)' %}
            {% elif car.price %}
              {% set price_line = '{:,.0f}'.format(car.price).replace(",", " ") ~ ' ' ~ (car.currency or '') %}
            {% endif %}
            <input type="hidden" name="preferred" value="{{ title_line }} /car/{{ car.id }}">
            <input type="hidden" name="comment" value="Авто: {{ title_line }}{% if price_line %} · Цена: {{ price_line }}{% endif %} · Ссылка: /car/{{ car.id }}">
            <input type="hidden" name="car_id" value="{{ car.id }}">
            <div class="field">
              <label for="lead-name">Имя</label>
              <input id="lead-name" name="name" type="text" required />
            </div>
            <div class="field">
              <label for="lead-phone">Телефон</label>
              <input id="lead-phone" name="phone" type="tel" required />
            </div>
            <div class="field">
              <label for="lead-email">Email (опционально)</label>
              <input id="lead-email" name="email" type="email" />
            </div>
            <div class="form-actions span-12">
              <button type="submit" class="btn btn-primary">Отправить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% set original_raw = (car.source_url or '')|trim %}
    {% if original_raw %}
    {% if original_raw.startswith('//') %}
      {% set original_url = 'https:' ~ original_raw %}
    {% elif original_raw.startswith('http://') or original_raw.startswith('https://') %}
      {% set original_url = original_raw %}
    {% else %}
      {% set original_url = 'https://' ~ original_raw %}
    {% endif %}
    <div class="card detail-origin-link">
      <a
        class="btn btn-secondary"
        href="{{ original_url }}"
        target="_blank"
        rel="noopener noreferrer nofollow"
      >
        Открыть оригинальное объявление
      </a>
    </div>
    {% endif %}
    {% endif %}
  </div>
</section>
<script>
  ;(() => {
    const init = () => {
      const leadBtn = document.getElementById('detail-lead-btn')
      const leadForm = document.getElementById('detail-lead-form')
      const backLink = document.getElementById('back-to-catalog')
      if (backLink) {
        const ref = document.referrer || ''
        const fromCatalog = ref.includes('/catalog')
        if (fromCatalog) {
          try {
            const url = new URL(ref)
            sessionStorage.setItem('catalogScroll', String(window.scrollY || 0))
            backLink.href = url.toString()
          } catch (e) {
            backLink.href = '/catalog'
          }
        } else {
          backLink.href = '/catalog'
        }
        backLink.style.display = ''
      }
      // кнопки уже инициализируются в app.js (initDetailActions)

      // gallery/breakdown handled in app.js
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      init()
    } else {
      document.addEventListener('DOMContentLoaded', init, { once: true })
    }
    window.addEventListener('load', init, { once: true })
    setTimeout(init, 300)
  })()
</script>
{% endblock %}
