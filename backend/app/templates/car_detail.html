{% extends "base.html" %} {% block title %}Авто — {{ car.brand }} {{ car.model
}}{% endblock %} {% block content %}
<section class="car-detail-page">
  <div class="la-container">
    {% if not car %}
    <div class="card">Автомобиль не найден.</div>
    {% else %}
    <div style="margin-bottom:12px;">
      <a id="back-to-catalog" class="btn btn-ghost btn-small" href="/catalog" style="display:none;">← Назад в каталог</a>
    </div>
    <div class="detail-hero">
      <div class="detail-gallery card">
        {% set image_urls = car.images|map(attribute='url')|list if car.images else [] %}
        {% set primary = image_urls[0] if image_urls and image_urls|length > 0 else car.thumbnail_url %}
        <div class="detail-hero__main placeholder" data-images='{{ image_urls | tojson }}'>
          {% if primary %}
          <img
            id="primaryImage"
            src="{{ primary }}"
            alt="{{ car.brand }} {{ car.model }}"
            loading="eager"
            decoding="async"
            width="960"
            height="640"
          />
          {% if image_urls and image_urls|length > 1 %}
          <button type="button" class="detail-nav detail-nav--prev" data-detail-prev aria-label="Предыдущее фото">‹</button>
          <button type="button" class="detail-nav detail-nav--next" data-detail-next aria-label="Следующее фото">›</button>
          {% endif %}
          {% else %}
          <div class="empty-placeholder">Нет фотографий</div>
          {% endif %}
        </div>
        {% if car.images and car.images|length > 1 %}
        <div class="detail-hero__thumbs">
          {% for im in car.images[:10] %}
          <button
            type="button"
            class="thumb"
            onclick="document.getElementById('primaryImage').src='{{ im.url }}'"
          >
            <img
              src="{{ im.url }}"
              alt="thumb {{ loop.index }}"
              loading="lazy"
              decoding="async"
              width="180"
              height="120"
            />
          </button>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      <div class="detail-info card">
        <div class="detail-heading">
            <div>
              <h1 class="detail-title">{{ car.brand or '' }} {{ car.model or '' }}</h1>
              {% set meta = [] %} {% if car.year %}{% set _ = meta.append(car.year) %}{% endif %} {% if car.display_engine_type or car.engine_type %}{% set _ = meta.append(car.display_engine_type or car.engine_type) %}{% endif %} {% if meta %}
              <p class="muted">{{ meta|join(' · ') }}</p>
              {% endif %}
              <p class="muted">
                {% if car.display_country_label or car.country %}Страна: {{ car.display_country_label or car.country }} · {% endif %} Фото:
                {{ car.images|length if car.images else 0 }}
              </p>
            </div>
          <div class="detail-price">
            {% set gross = pricing.gross_eur if pricing else None %}
            {% set net = pricing.net_eur if pricing else None %}
            {% set vat_pct = pricing.vat_percent if pricing else None %}
            {% set vat_reclaim = pricing.vat_reclaimable if pricing else False %}
            {% if calc and calc.total_rub %}
            <div class="detail-price__total">
              {{ '{:,.0f}'.format(calc.total_rub).replace(',', ' ') }} ₽
            </div>
            {% endif %}
            <div class="detail-price__base">
              {% if gross %}
                BRUTTO: {{ '{:,.0f}'.format(gross).replace(',', ' ') }} €
              {% elif car.price %}
                Цена: {{ '{:,.0f}'.format(car.price).replace(',', ' ') }} {{ car.currency or '' }}
              {% else %}
                Цена по запросу
              {% endif %}
              {% if net %}
                <br>NET: {{ '{:,.0f}'.format(net).replace(',', ' ') }} €
              {% endif %}
              {% if vat_pct is not none %}
                <br>НДС: {% if vat_reclaim %}возмещается ({{ vat_pct }}%){% else %}не возмещается{% endif %}
              {% endif %}
              {% if not calc or not calc.total_rub %}
                <br><span class="muted">* Итог в РФ не рассчитан</span>
              {% endif %}
            </div>
          {% if user %}
          <button class="fav-btn" data-fav-button data-car-id="{{ car.id }}" aria-label="Добавить в избранное">★</button>
          {% endif %}
          </div>
        </div>
        {% if calc %}
        <div class="detail-calc">
          <button class="btn btn-ghost btn-small" type="button" id="toggleCalc">Детали доставки</button>
          <div class="detail-calc__line" id="calcBreakdown" style="display:none;">
            {% if calc.breakdown and calc.breakdown|length > 0 %}
              {% for item in calc.breakdown %}
              <div class="calc-chip">
                <span>{{ item.title }}</span>
                <span>{{ '{:,.0f}'.format(item.amount_rub).replace(',', ' ') }} ₽</span>
              </div>
              {% endfor %}
            {% else %}
              <div class="muted">Недостаточно данных для расчёта стоимости.</div>
            {% endif %}
          </div>
        </div>
        {% endif %}
        <div class="detail-specs">
          {% if car.mileage %}
          <div class="chip">Пробег: {{ car.mileage }}</div>
          {% endif %} {% if car.body_type %}
          <div class="chip">Кузов: {{ car.display_body_type or car.body_type }}</div>
          {% endif %} {% if car.drive_type %}
          <div class="chip">Привод: {{ car.drive_type }}</div>
          {% endif %} {% if car.color %}
          <div class="chip">Цвет: {{ car.display_color or car.color }}</div>
          {% endif %} {% if car.display_country_label or car.country %}
          <div class="chip">Страна: {{ car.display_country_label or car.country }}</div>
          {% endif %} {% if car.vin %}
          <div class="chip">VIN: {{ car.vin }}</div>
          {% endif %}
        </div>
        {% if car_details and car_details|length > 0 %}
        <div class="detail-state card">
          <h3>Состояние авто</h3>
          <div class="detail-state__grid">
            {% for item in car_details %}
            <div class="detail-state__item">
              <span class="label">{{ item.label }}</span>
              <span class="value">{{ item.value }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        {% if car_options and car_options|length > 0 %}
        <div class="detail-options card">
          <h3>Оснащение</h3>
          <div class="detail-options__chips">
            {% for opt in car_options %}
            <div class="calc-chip">{{ opt }}</div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <div class="detail-actions">
          <div class="detail-actions__lead">
            <button class="btn cta-lead" id="detail-lead-btn">
              Связаться
            </button>
          </div>
        </div>
        <div id="detail-lead-form" class="card" style="margin-top:12px; display:none;">
          <form method="post" action="/lead" class="form-grid form-grid--12">
            <input type="hidden" name="preferred" value="{{ car.brand or '' }} {{ car.model or '' }} {% if car.year %}{{ car.year }}{% endif %} /car/{{ car.id }}">
            <input type="hidden" name="comment" value="Авто: {{ car.brand or '' }} {{ car.model or '' }} {% if car.year %}{{ car.year }}{% endif %} /car/{{ car.id }}">
            <input type="hidden" name="car_id" value="{{ car.id }}">
            <div class="field span-6">
              <label for="lead-name">Имя</label>
              <input id="lead-name" name="name" type="text" required />
            </div>
            <div class="field span-6">
              <label for="lead-phone">Телефон</label>
              <input id="lead-phone" name="phone" type="tel" required />
            </div>
            <div class="field span-6">
              <label for="lead-email">Email (опционально)</label>
              <input id="lead-email" name="email" type="email" />
            </div>
            <div class="form-actions span-12">
              <button type="submit" class="btn btn-primary">Отправить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</section>
{% block scripts_extra %}
<script>
  (() => {
    const leadBtn = document.getElementById('detail-lead-btn')
    const leadForm = document.getElementById('detail-lead-form')
    const backLink = document.getElementById('back-to-catalog')
    if (backLink) {
      const ref = document.referrer || ''
      const fromCatalog = ref.includes('/catalog')
      if (fromCatalog) {
        const url = new URL(ref)
        sessionStorage.setItem('catalogScroll', String(window.scrollY))
        backLink.href = url.toString()
      } else {
        backLink.href = '/catalog'
      }
      backLink.style.display = ''
    }
    if (leadBtn) {
      leadBtn.addEventListener('click', (e) => {
        e.preventDefault()
        if (leadForm) leadForm.style.display = leadForm.style.display === 'none' ? '' : 'none'
      })
    }
    // gallery navigation
    const mainWrap = document.querySelector('.detail-hero__main')
    if (mainWrap) {
      let startX = null
      const imgs = (() => {
        try {
          const data = mainWrap.dataset.images ? JSON.parse(mainWrap.dataset.images) : []
          return Array.isArray(data) ? data : []
        } catch (e) {
          return []
        }
      })()
      const imgEl = document.getElementById('primaryImage')
      if (imgEl && imgs.length > 1) {
        let idx = 0
        const setImg = (next) => {
          idx = (next + imgs.length) % imgs.length
          imgEl.src = imgs[idx]
        }
        document.querySelector('[data-detail-prev]')?.addEventListener('click', (e) => {
          e.preventDefault()
          setImg(idx - 1)
        })
        document.querySelector('[data-detail-next]')?.addEventListener('click', (e) => {
          e.preventDefault()
          setImg(idx + 1)
        })
        mainWrap.addEventListener('touchstart', (e) => {
          if (e.touches.length) startX = e.touches[0].clientX
        })
        mainWrap.addEventListener('touchend', (e) => {
          if (startX == null) return
          const diff = e.changedTouches[0].clientX - startX
          if (Math.abs(diff) > 30) setImg(diff > 0 ? idx - 1 : idx + 1)
          startX = null
        })
        let startX = null
      }
    }

    // breakdown toggle
    const toggleCalc = document.getElementById('toggleCalc')
    const calcBlock = document.getElementById('calcBreakdown')
    if (toggleCalc && calcBlock) {
      toggleCalc.addEventListener('click', () => {
        const isHidden = calcBlock.style.display === 'none'
        calcBlock.style.display = isHidden ? '' : 'none'
      })
    }
  })()
</script>
{% endblock %}
{% endblock %}
