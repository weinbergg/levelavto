{% extends "base.html" %} {% block title %}Авто — {{ car.brand }} {{ car.model
}}{% endblock %} {% block content %}
<section class="car-detail-page">
  <div class="la-container">
    {% if not car %}
    <div class="card">Автомобиль не найден.</div>
    {% else %}
    <div style="margin-bottom:12px;">
      <a id="back-to-catalog" class="btn btn-ghost btn-small" href="/catalog" style="display:none;">← Назад в каталог</a>
    </div>
    <div class="detail-hero">
      <div class="detail-gallery card">
        {% set image_urls = car.images|map(attribute='url')|list if car.images else [] %}
        {% set primary = image_urls[0] if image_urls and image_urls|length > 0 else car.thumbnail_url %}
        <div class="detail-hero__main placeholder" data-images='{{ image_urls | tojson }}'>
          {% if primary %}
          <img
            id="primaryImage"
            src="{{ primary }}"
            alt="{{ car.brand }} {{ car.model }}"
            loading="eager"
            decoding="async"
            width="960"
            height="640"
          />
          {% if image_urls and image_urls|length > 1 %}
          <button type="button" class="detail-nav detail-nav--prev" data-detail-prev aria-label="Предыдущее фото">‹</button>
          <button type="button" class="detail-nav detail-nav--next" data-detail-next aria-label="Следующее фото">›</button>
          {% endif %}
          {% else %}
          <div class="empty-placeholder">Нет фотографий</div>
          {% endif %}
        </div>
        {% if car.images and car.images|length > 1 %}
        <div class="detail-hero__thumbs">
          {% for im in car.images[:30] %}
          <button
            type="button"
            class="thumb"
            data-thumb-index="{{ loop.index0 }}"
            onclick="document.getElementById('primaryImage').src='{{ im.url }}'"
          >
            <img
              src="{{ im.url }}"
              alt="thumb {{ loop.index }}"
              loading="lazy"
              decoding="async"
              width="180"
              height="120"
            />
          </button>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      <div class="detail-info card">
        <div class="detail-heading">
          <h1 class="detail-title">{{ car.brand or '' }} {{ car.model or '' }}</h1>
          {% set meta = [] %} {% if car.year %}{% set _ = meta.append(car.year) %}{% endif %} {% if car.display_engine_type or car.engine_type %}{% set _ = meta.append(car.display_engine_type or car.engine_type) %}{% endif %}
          {% set gross = pricing.gross_eur if pricing else None %}
          {% set net = pricing.net_eur if pricing else None %}
          {% set vat_pct = pricing.vat_percent if pricing else None %}
          {% set vat_reclaim = pricing.vat_reclaimable if pricing else False %}
          {% set display_price = car.display_price_rub %}
          <div class="detail-price">
            <div class="detail-price__total">
              {% if display_price %}
                {% set display_price_round = ((display_price + 9999) // 10000) * 10000 %}
                {{ '{:,.0f}'.format(display_price_round).replace(',', ' ') }} ₽
              {% else %}
                Цена уточняется
              {% endif %}
            </div>
            <div class="detail-price__meta">
              {% if gross %}
              BRUTTO: {{ '{:,.0f}'.format(gross).replace(',', ' ') }} €
              {% elif car.price %}
              Цена: {{ '{:,.0f}'.format(car.price).replace(',', ' ') }} {{ car.currency or '' }}
              {% endif %}
              {% if net %}
              <br>NET: {{ '{:,.0f}'.format(net).replace(',', ' ') }} €
              {% endif %}
              {% if vat_pct is not none %}
              <br>НДС: {% if vat_reclaim %}возмещается ({{ vat_pct }}%){% else %}не возмещается{% endif %}
              {% endif %}
            </div>
            {% if car.price_note %}
            <div class="detail-price__note">{{ car.price_note }}</div>
            {% endif %}
          </div>
          {% if meta %}
          <p class="muted detail-meta">{{ meta|join(' · ') }}</p>
          {% endif %}
          <p class="muted">
            {% if car.display_country_label or car.country %}Страна: {{ car.display_country_label or car.country }} · {% endif %} Фото:
            {{ car.images|length if car.images else 0 }}
          </p>
          {% if user %}
          <button class="fav-btn" data-fav-button data-car-id="{{ car.id }}" aria-label="Добавить в избранное">★</button>
          {% endif %}
        </div>
        <div class="detail-specs">
          {% if car.mileage %}
          <div class="chip">Пробег: {{ car.mileage }}</div>
          {% endif %} {% if car.body_type %}
          <div class="chip">Кузов: {{ car.display_body_type or car.body_type }}</div>
          {% endif %} {% if car.drive_type %}
          <div class="chip">Привод: {{ car.drive_type }}</div>
          {% endif %} {% if car.color %}
          <div class="chip">Цвет: {{ car.display_color or car.color }}</div>
          {% endif %} {% if car.display_country_label or car.country %}
          <div class="chip">Страна: {{ car.display_country_label or car.country }}</div>
          {% endif %} {% if car.vin %}
          <div class="chip">VIN: {{ car.vin }}</div>
          {% endif %}
          {% if car.power_hp %}
          <div class="chip">Мощность: {{ car.power_hp }} л.с.</div>
          {% endif %}
          {% if car.engine_cc %}
          <div class="chip">Объём: {{ car.engine_cc }} см³</div>
          {% endif %}
        </div>
        {% if car_details and car_details|length > 0 %}
        <div class="detail-state card">
          <h3>Состояние авто</h3>
          <div class="detail-state__grid">
            {% for item in car_details %}
            <div class="detail-state__item">
              <span class="label">{{ item.label }}</span>
              <span class="value">{{ item.value }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        {% if car_options and car_options|length > 0 %}
        <div class="detail-options card">
          <h3>Оснащение</h3>
          <div class="detail-options__chips">
            {% for opt in car_options %}
            <div class="calc-chip">{{ opt }}</div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <div class="detail-actions">
          <div class="detail-actions__lead">
            <button class="btn cta-lead" id="detail-lead-btn" type="button" onclick="return window.toggleLeadForm(event);">
              Связаться
            </button>
          </div>
        </div>
        <div id="detail-lead-form" class="card" style="margin-top:12px; display:none;">
          <form method="post" action="/lead" class="form-grid form-grid--12 lead-form-grid">
            {% set title_line = (car.brand or '') ~ ' ' ~ (car.model or '') ~ (' ' ~ car.year if car.year else '') %}
            {% set price_line = '' %}
            {% if calc and calc.total_rub %}
              {% set price_line = '{:,.0f}'.format(calc.total_rub).replace(",", " ") ~ ' ₽ (итог в РФ)' %}
            {% elif pricing and pricing.gross_eur %}
              {% set price_line = '{:,.0f}'.format(pricing.gross_eur).replace(",", " ") ~ ' € (BRUTTO)' %}
            {% elif car.price %}
              {% set price_line = '{:,.0f}'.format(car.price).replace(",", " ") ~ ' ' ~ (car.currency or '') %}
            {% endif %}
            <input type="hidden" name="preferred" value="{{ title_line }} /car/{{ car.id }}">
            <input type="hidden" name="comment" value="Авто: {{ title_line }}{% if price_line %} · Цена: {{ price_line }}{% endif %} · Ссылка: /car/{{ car.id }}">
            <input type="hidden" name="car_id" value="{{ car.id }}">
            <div class="field">
              <label for="lead-name">Имя</label>
              <input id="lead-name" name="name" type="text" required />
            </div>
            <div class="field">
              <label for="lead-phone">Телефон</label>
              <input id="lead-phone" name="phone" type="tel" required />
            </div>
            <div class="field">
              <label for="lead-email">Email (опционально)</label>
              <input id="lead-email" name="email" type="email" />
            </div>
            <div class="form-actions span-12">
              <button type="submit" class="btn btn-primary">Отправить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</section>
<script>
  ;(() => {
    const init = () => {
      const leadBtn = document.getElementById('detail-lead-btn')
      const leadForm = document.getElementById('detail-lead-form')
      const backLink = document.getElementById('back-to-catalog')
      if (backLink) {
        const ref = document.referrer || ''
        const fromCatalog = ref.includes('/catalog')
        if (fromCatalog) {
          try {
            const url = new URL(ref)
            sessionStorage.setItem('catalogScroll', String(window.scrollY || 0))
            backLink.href = url.toString()
          } catch (e) {
            backLink.href = '/catalog'
          }
        } else {
          backLink.href = '/catalog'
        }
        backLink.style.display = ''
      }
      // кнопки уже инициализируются в app.js (initDetailActions)

      // gallery navigation (skip if app.js handled)
      if (window.__detailGalleryHandled) return
      const mainWrap = document.querySelector('.detail-hero__main')
      if (mainWrap && !mainWrap.dataset.bound) {
        let startX = null
        let idx = 0
        let imgs = []
        try {
          const data = mainWrap.dataset.images ? JSON.parse(mainWrap.dataset.images) : []
          if (Array.isArray(data)) imgs = data
        } catch (e) {
          imgs = []
        }
        const imgEl = document.getElementById('primaryImage')
        const thumbs = Array.from(document.querySelectorAll('.detail-hero__thumbs .thumb'))
        const normalize = (u) => {
          const val = String(u || '').trim()
          if (!val) return ''
          if (val.startsWith('//')) return `https:${val}`
          if (val.startsWith('http://')) return val.replace('http://', 'https://')
          if (val.startsWith('https://') || val.startsWith('/')) return val
          if (val.startsWith('api/v1/mo-prod/images/')) return `https://img.classistatic.de/${val}`
          if (val.startsWith('img.classistatic.de/')) return `https://${val}`
          return ''
        }
        const setImg = (next) => {
          if (!imgEl || !imgs.length) return
          idx = (next + imgs.length) % imgs.length
          const nextSrc = normalize(imgs[idx])
          if (nextSrc) imgEl.src = nextSrc
          thumbs.forEach((t, i) => t.classList.toggle('active', i === idx))
        }
        const prevBtn = document.querySelector('[data-detail-prev]')
        const nextBtn = document.querySelector('[data-detail-next]')
        if (prevBtn && !prevBtn.dataset.bound) {
          prevBtn.addEventListener('click', (e) => {
            e.preventDefault()
            setImg(idx - 1)
          })
          prevBtn.dataset.bound = '1'
        }
        if (nextBtn && !nextBtn.dataset.bound) {
          nextBtn.addEventListener('click', (e) => {
            e.preventDefault()
            setImg(idx + 1)
          })
          nextBtn.dataset.bound = '1'
        }
        mainWrap.addEventListener('touchstart', (e) => {
          if (e.touches.length) startX = e.touches[0].clientX
        })
        mainWrap.addEventListener('touchend', (e) => {
          if (startX == null) return
          const diff = e.changedTouches[0].clientX - startX
          if (Math.abs(diff) > 30) setImg(diff > 0 ? idx - 1 : idx + 1)
          startX = null
        })
        if (thumbs.length) {
          thumbs.forEach((btn, i) => {
            if (btn.dataset.bound) return
            btn.addEventListener('click', (e) => {
              e.preventDefault()
              setImg(i)
            })
            btn.dataset.bound = '1'
          })
        }
        if (imgs.length) setImg(0)
        mainWrap.dataset.bound = '1'
      }

      // breakdown handled in app.js
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      init()
    } else {
      document.addEventListener('DOMContentLoaded', init, { once: true })
    }
    window.addEventListener('load', init, { once: true })
    setTimeout(init, 300)
  })()
</script>
{% endblock %}
