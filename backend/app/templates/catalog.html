{% extends "base.html" %}
{% block title %}Каталог — Автокаталог{% endblock %}
{% block content %}
<section class="catalog">
  <div class="la-container catalog__layout">
    <div class="filters-overlay" id="filtersOverlay" aria-hidden="true"></div>
    <aside class="filters-panel" id="filtersPanel">
      <div class="filters-panel__header">
        <h3>Фильтры</h3>
        <button class="filters-panel__close" type="button" id="filtersClose" aria-label="Закрыть фильтры">×</button>
      </div>
      <form id="filters" onsubmit="return false;">
        {% set params = request.query_params %}
        <div class="filters-primary">
          <div class="filters-primary-grid">
            {% if countries %}
            <label>Страна
              <select name="country" id="country">
                <option value="">Все</option>
                {% for c in countries %}
                <option value="{{ c }}" {% if params.get('country') == c %}selected{% endif %}>{{ country_labels.get(c, c) }}</option>
                {% endfor %}
              </select>
            </label>
            {% endif %}
            <label>Марка
              <select name="brand" id="brand">
                <option value="">Все</option>
                {% for b in brands|sort %}
                <option value="{{ b }}" {% if params.get('brand') == b %}selected{% endif %}>{{ b }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Модель
              <select name="model" id="model-select" {% if not params.get('brand') %}disabled{% endif %}>
                <option value="">{{ params.get('model','') or 'Все' }}</option>
              </select>
            </label>
            {% if generations %}
            <label>Поколение
              <select name="generation" id="generation">
                <option value="">Любое</option>
                {% for g in generations %}
                <option value="{{ g }}" {% if params.get('generation') == g %}selected{% endif %}>{{ g }}</option>
                {% endfor %}
              </select>
            </label>
            {% endif %}
            <label>Цена от, ₽
              <select name="price_min">
                <option value="">Любая</option>
                {% for p in price_options %}
                <option value="{{ p }}" {% if params.get('price_min')|int == p %}selected{% endif %}>
                  {{ '{:,.0f}'.format(p).replace(',', ' ') }}
                </option>
                {% endfor %}
              </select>
            </label>
            <label>Цена до, ₽
              <select name="price_max">
                <option value="">Любая</option>
                {% for p in price_options %}
                <option value="{{ p }}" {% if params.get('price_max')|int == p %}selected{% endif %}>
                  {{ '{:,.0f}'.format(p).replace(',', ' ') }}
                </option>
                {% endfor %}
              </select>
            </label>
            {% if reg_years %}
            <label>Поставлен на учёт с (год)
              <select name="reg_year_min" id="reg-year-min">
                <option value="">Не важно</option>
                {% for y in reg_years %}
                <option value="{{ y }}" {% if params.get('reg_year_min')|int == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </label>
            <label data-reg-month="min">Поставлен на учёт с (месяц)
              <select name="reg_month_min" id="reg-month-min">
                <option value="">Не важно</option>
                {% for m in reg_months %}
                <option value="{{ m.value }}" {% if params.get('reg_month_min')|int == m.value %}selected{% endif %}>{{ m.label }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Поставлен на учёт по (год)
              <select name="reg_year_max" id="reg-year-max">
                <option value="">Не важно</option>
                {% for y in reg_years %}
                <option value="{{ y }}" {% if params.get('reg_year_max')|int == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </label>
            <label data-reg-month="max">Поставлен на учёт по (месяц)
              <select name="reg_month_max" id="reg-month-max">
                <option value="">Не важно</option>
                {% for m in reg_months %}
                <option value="{{ m.value }}" {% if params.get('reg_month_max')|int == m.value %}selected{% endif %}>{{ m.label }}</option>
                {% endfor %}
              </select>
            </label>
            {% endif %}
            <label>Пробег от, км
              <select name="mileage_min">
                <option value="">Любой</option>
                {% for m in mileage_options %}
                <option value="{{ m }}" {% if params.get('mileage_min')|int == m %}selected{% endif %}>
                  {{ '{:,.0f}'.format(m).replace(',', ' ') }}
                </option>
                {% endfor %}
              </select>
            </label>
            <label>Пробег до, км
              <select name="mileage_max">
                <option value="">Любой</option>
                {% for m in mileage_options %}
                <option value="{{ m }}" {% if params.get('mileage_max')|int == m %}selected{% endif %}>
                  {{ '{:,.0f}'.format(m).replace(',', ' ') }}
                </option>
                {% endfor %}
              </select>
            </label>
            {% if engine_types and engine_types|length > 0 %}
            <label>Топливо
              <select name="engine_type">
                <option value="">Любое</option>
                {% for t in engine_types %}
                <option value="{{ t.value }}" {% if params.get('engine_type') == t.value %}selected{% endif %}>{{ t.label }}</option>
                {% endfor %}
              </select>
            </label>
            {% endif %}
            {% if transmissions and transmissions|length > 0 %}
            <label>Трансмиссия
              <select name="transmission">
                <option value="">Любая</option>
                {% for t in transmissions %}
                <option value="{{ t.value }}" {% if params.get('transmission') == t.value %}selected{% endif %}>{{ t.label }}</option>
                {% endfor %}
              </select>
            </label>
            {% endif %}
            {% if (colors_basic and colors_basic|length > 0) or (colors_other and colors_other|length > 0) %}
            <label class="field--full">Цвет
              {% if colors_basic and colors_basic|length > 0 %}
              <div class="color-swatches color-swatches--basic" data-color-chips>
                {% for c in colors_basic %}
                <button
                  type="button"
                  class="color-chip {% if params.get('color') == c.value %}active{% endif %}"
                  data-color="{{ c.value }}"
                  data-label="{{ c.label }}"
                  title="{{ c.label }}"
                  aria-label="{{ c.label }}"
                  {% if c.hex %}style="--chip-color: {{ c.hex }}"{% endif %}
                ></button>
                {% endfor %}
              </div>
              {% endif %}
              {% if colors_other and colors_other|length > 0 %}
              <button type="button" class="btn btn-ghost btn-small color-toggle" id="colorsToggle" aria-expanded="false">
                Другие цвета
              </button>
              <div class="color-swatches color-swatches-extra is-collapsed" id="colorsExtra" data-color-chips>
                {% for c in colors_other %}
                <button
                  type="button"
                  class="color-chip {% if params.get('color') == c.value %}active{% endif %}"
                  data-color="{{ c.value }}"
                  data-label="{{ c.label }}"
                  title="{{ c.label }}"
                  aria-label="{{ c.label }}"
                  {% if c.hex %}style="--chip-color: {{ c.hex }}"{% endif %}
                ></button>
                {% endfor %}
              </div>
              {% endif %}
              <input type="hidden" name="color" value="{{ params.get('color','') }}">
            </label>
            {% endif %}
          </div>
        </div>

        <div class="filters-actions">
          <button class="btn btn-ghost" id="resetFilters" type="button">Сбросить</button>
          <button class="btn btn-primary" id="applyFilters">Применить</button>
        </div>
        <input type="hidden" name="sort" id="sortHidden" value="{{ params.get('sort','price_asc') }}">
        <input type="hidden" name="page" value="{{ request.query_params.get('page', '1') if request else '1' }}">
      </form>
    </aside>
    <div class="catalog__content">
      <div class="results-header">
        <h1 style="margin:0;">Каталог</h1>
        <div class="results-header__actions">
          <button class="btn btn-secondary filters-toggle" type="button" id="filtersToggle">Фильтры</button>
          <div class="catalog-sort">
            <label for="sort-select">Сортировать по:</label>
            <select name="sort" id="sort-select">
              <option value="price_asc" {% if params.get('sort','price_asc') == 'price_asc' %}selected{% endif %}>Цена (сначала дешевые)</option>
              <option value="price_desc" {% if params.get('sort') == 'price_desc' %}selected{% endif %}>Цена (сначала дорогие)</option>
              <option value="mileage_asc" {% if params.get('sort') == 'mileage_asc' %}selected{% endif %}>Пробег</option>
              <option value="year_desc" {% if params.get('sort') == 'year_desc' %}selected{% endif %}>Год/дата</option>
            </select>
          </div>
        </div>
      </div>
      <div class="active-filters-row">
        <div id="resultCount" class="muted"></div>
        <div id="activeFilters" class="active-filters"></div>
      </div>
      <div id="spinner" class="spinner" style="display:none;">Загрузка…</div>
      <div id="cards" class="cards"></div>
      <div class="pagination">
        <button class="btn" id="prevPage">‹</button>
        <div id="pageNumbers" class="page-numbers"></div>
        <button class="btn" id="nextPage">›</button>
      </div>
      <div id="pageInfo" class="muted"></div>
    </div>
  </div>
</section>
<script>
  window.CATALOG_API = "/api/cars";
</script>
{% endblock %}
