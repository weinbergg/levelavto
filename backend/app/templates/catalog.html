{% extends "base.html" %}
{% block title %}Каталог — Автокаталог{% endblock %}
{% block content %}
<section class="catalog">
  <div class="la-container catalog__layout">
    <div class="filters-overlay" id="filtersOverlay" aria-hidden="true"></div>
    <aside class="filters-panel" id="filtersPanel">
      <div class="filters-panel__header">
        <h3>Фильтры</h3>
        <button class="filters-panel__close" type="button" id="filtersClose" aria-label="Закрыть фильтры">×</button>
      </div>
      <form id="filters" onsubmit="return false;">
        {% set params = request.query_params %}
        <div class="filters-primary">
          <div class="filters-primary-grid">
            {% set region_value = params.get('region') %}
            {% if not region_value %}
              {% if params.get('country') == 'KR' %}
                {% set region_value = 'KR' %}
              {% elif params.get('country') %}
                {% set region_value = 'EU' %}
              {% endif %}
            {% endif %}
            {% if regions %}
            <label>Регион
              <select name="region" id="region" data-region-select>
                <option value="">Все регионы</option>
                {% for r in regions %}
                <option value="{{ r }}" {% if region_value == r %}selected{% endif %}>{{ country_labels.get(r, r) }}</option>
                {% endfor %}
              </select>
            </label>
            {% endif %}
            <label data-region-panel="eu">Страна (Европа)
              <select name="country" id="country" data-country>
                <option value="">Все страны</option>
                {% for c in countries %}
                <option value="{{ c }}" {% if params.get('country') == c %}selected{% endif %}>{{ country_labels.get(c, c) }}</option>
                {% endfor %}
              </select>
            </label>
            {% if kr_types %}
            <label data-region-panel="kr">Корея
              <select name="kr_type" id="kr-type" data-kr-type>
                <option value="">Корейские</option>
                {% for kt in kr_types %}
                <option value="{{ kt.value }}" {% if params.get('kr_type')|upper == kt.value %}selected{% endif %}>{{ kt.label }}</option>
                {% endfor %}
              </select>
            </label>
            {% endif %}
            <label>Состояние
              <select name="condition" id="condition">
                <option value="">Все</option>
                <option value="new" {% if params.get('condition') == 'new' %}selected{% endif %}>Новые</option>
                <option value="used" {% if params.get('condition') == 'used' %}selected{% endif %}>С пробегом</option>
              </select>
            </label>
            <label>Марка
              <select name="brand" id="brand">
                <option value="">Все</option>
                {% for b in brands|sort %}
                <option value="{{ b }}" {% if params.get('brand') == b %}selected{% endif %}>{{ b }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Модель
              <select name="model" id="model-select" {% if not params.get('brand') %}disabled{% endif %}>
                <option value="">Все</option>
                {% if params.get('model') %}
                <option value="{{ params.get('model') }}" selected>{{ params.get('model') }}</option>
                {% endif %}
              </select>
            </label>
            <div class="filters-row">
              <label>Цена от, ₽
                <input type="number" name="price_min" inputmode="numeric" min="0" step="1000" value="{{ params.get('price_min','') }}" placeholder="от">
              </label>
              <label>Цена до, ₽
                <input type="number" name="price_max" inputmode="numeric" min="0" step="1000" value="{{ params.get('price_max','') }}" placeholder="до">
              </label>
            </div>
            <div class="filters-row">
              <label>Пробег от, км
                <input type="number" name="mileage_min" inputmode="numeric" min="0" step="1" value="{{ params.get('mileage_min','') }}" placeholder="от">
              </label>
              <label>Пробег до, км
                <input type="number" name="mileage_max" inputmode="numeric" min="0" step="1" value="{{ params.get('mileage_max','') }}" placeholder="до">
              </label>
            </div>
            <label>Кузов
              <select name="body_type" id="body_type">
                <option value="">Любой</option>
                {% for t in body_types %}
                <option value="{{ t.value }}" {% if params.get('body_type') == t.value %}selected{% endif %}>{{ t.label }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Поколение
              <select name="generation" id="generation">
                <option value="">Любое</option>
                {% for g in generations %}
                <option value="{{ g }}" {% if params.get('generation') == g %}selected{% endif %}>{{ g }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="field--full">Цвет кузова
              <div class="color-swatches color-swatches--basic" data-color-chips>
                {% for c in colors_basic %}
                <button
                  type="button"
                  class="color-chip"
                  data-color="{{ c.value }}"
                  data-label="{{ c.label }}"
                  title="{{ c.label }}"
                  aria-label="{{ c.label }}"
                  {% if c.hex %}style="--chip-color: {{ c.hex }}"{% endif %}
                ></button>
                {% endfor %}
              </div>
              <button
                type="button"
                class="btn btn-ghost btn-small color-toggle"
                data-colors-toggle
                data-target="colors-extra-catalog"
                aria-expanded="false"
              >
                Другие цвета
              </button>
              <div class="color-swatches color-swatches-extra is-collapsed" id="colors-extra-catalog" data-color-chips>
                {% for c in colors_other %}
                <button
                  type="button"
                  class="color-chip"
                  data-color="{{ c.value }}"
                  data-label="{{ c.label }}"
                  title="{{ c.label }}"
                  aria-label="{{ c.label }}"
                  {% if c.hex %}style="--chip-color: {{ c.hex }}"{% endif %}
                ></button>
                {% endfor %}
              </div>
              <input type="hidden" name="color" value="{{ params.get('color','') }}">
            </label>
            <label class="reg-range">Поставлен на учёт с / по
              <div class="reg-range__inputs">
                <div class="reg-range__col">
                  <select name="reg_year_min" id="reg-year-min">
                    <option value="">Не важно</option>
                    {% for y in reg_years %}
                    <option value="{{ y }}" {% if params.get('reg_year_min')|int == y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                  </select>
                  <select name="reg_month_min" id="reg-month-min" data-reg-month="min">
                    <option value="">Месяц</option>
                    {% for m in reg_months %}
                    <option value="{{ m.value }}" {% if params.get('reg_month_min')|int == m.value %}selected{% endif %}>{{ m.label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="reg-range__col">
                  <select name="reg_year_max" id="reg-year-max">
                    <option value="">Не важно</option>
                    {% for y in reg_years %}
                    <option value="{{ y }}" {% if params.get('reg_year_max')|int == y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                  </select>
                  <select name="reg_month_max" id="reg-month-max" data-reg-month="max">
                    <option value="">Месяц</option>
                    {% for m in reg_months %}
                    <option value="{{ m.value }}" {% if params.get('reg_month_max')|int == m.value %}selected{% endif %}>{{ m.label }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </label>
            <label>Топливо
              <select name="engine_type">
                <option value="">Любое</option>
                {% for t in engine_types %}
                <option value="{{ t.value }}" {% if params.get('engine_type') == t.value %}selected{% endif %}>{{ t.label }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Трансмиссия
              <select name="transmission">
                <option value="">Любая</option>
                {% for t in transmissions %}
                <option value="{{ t.value }}" {% if params.get('transmission') == t.value %}selected{% endif %}>{{ t.label }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Привод
              <select name="drive_type">
                <option value="">Любой</option>
                {% for t in drive_types %}
                <option value="{{ t.value }}" {% if params.get('drive_type') == t.value %}selected{% endif %}>{{ t.label }}</option>
                {% endfor %}
              </select>
            </label>
            <div class="filters-range">
              <label>Мощность от, л.с
                <input type="number" name="power_hp_min" inputmode="numeric" min="0" step="10" value="{{ params.get('power_hp_min','') }}">
              </label>
              <label>Мощность до, л.с
                <input type="number" name="power_hp_max" inputmode="numeric" min="0" step="10" value="{{ params.get('power_hp_max','') }}">
              </label>
            </div>
            <div class="filters-range">
              <label>Объём двигателя от, см³
                <input type="number" name="engine_cc_min" inputmode="numeric" min="0" step="100" value="{{ params.get('engine_cc_min','') }}">
              </label>
              <label>Объём двигателя до, см³
                <input type="number" name="engine_cc_max" inputmode="numeric" min="0" step="100" value="{{ params.get('engine_cc_max','') }}">
              </label>
            </div>
            <!-- interior filters moved to advanced search; hidden in main panel -->
            {# фильтр пневмоподвески скрыт: данных нет или не используется #}
            {# Цвет убран из основной панели; оставьте в расширенном поиске при наличии данных #}
            <label class="field--full">Поиск по ключевым словам
              <input type="text" name="q" value="{{ params.get('q','') }}" placeholder="Например: дизель, 4x4, панорама">
            </label>
          </div>
        </div>

        <div class="filters-actions">
          <button class="btn btn-ghost" id="resetFilters" type="button">Сбросить</button>
        </div>
        <div class="filters-extra">
          <a class="btn btn-secondary" id="catalog-advanced-link" href="/search">Расширенный поиск</a>
        </div>
        {% for line in params.getlist('line') %}
        <input type="hidden" name="line" value="{{ line }}">
        {% endfor %}
        {% set adv_keys = ['num_seats','doors_count','emission_class','efficiency_class','climatisation','airbags','interior_design','price_rating_label','owners_count'] %}
        {% for key in adv_keys %}
          {% if params.get(key) %}
          <input type="hidden" name="{{ key }}" value="{{ params.get(key) }}">
          {% endif %}
        {% endfor %}
        <input type="hidden" name="sort" id="sortHidden" value="{{ params.get('sort','price_asc') }}">
        <input type="hidden" name="page" value="{{ request.query_params.get('page', '1') if request else '1' }}">
      </form>
    </aside>
    <div class="catalog__content">
      <div class="results-header">
        <h1 style="margin:0;">Каталог</h1>
        <div class="results-header__actions">
          <button class="btn btn-secondary filters-toggle" type="button" id="filtersToggle">Фильтры</button>
          <div class="catalog-sort">
            <label for="sort-select">Сортировать по:</label>
            <select name="sort" id="sort-select">
              <option value="price_asc" {% if params.get('sort','price_asc') == 'price_asc' %}selected{% endif %}>Цена (сначала дешевые)</option>
              <option value="price_desc" {% if params.get('sort') == 'price_desc' %}selected{% endif %}>Цена (сначала дорогие)</option>
              <option value="mileage_asc" {% if params.get('sort') == 'mileage_asc' %}selected{% endif %}>Пробег (сначала меньше)</option>
              <option value="mileage_desc" {% if params.get('sort') == 'mileage_desc' %}selected{% endif %}>Пробег (сначала больше)</option>
              <option value="reg_desc" {% if params.get('sort') == 'reg_desc' %}selected{% endif %}>Постановка на учёт (сначала новые)</option>
              <option value="reg_asc" {% if params.get('sort') == 'reg_asc' %}selected{% endif %}>Постановка на учёт (сначала старые)</option>
              <option value="listing_desc" {% if params.get('sort') == 'listing_desc' %}selected{% endif %}>Дата размещения (сначала новые)</option>
              <option value="listing_asc" {% if params.get('sort') == 'listing_asc' %}selected{% endif %}>Дата размещения (сначала старые)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="active-filters-row">
        <div id="resultCount" class="muted"></div>
        <div id="activeFilters" class="active-filters"></div>
      </div>
      <div id="spinner" class="spinner" style="display:none;">Загрузка…</div>
      <div id="cards" class="cards" data-ssr="{{ 1 if initial_items and initial_items|length > 0 else 0 }}" data-ssr-params="{{ request.url.query }}">
        {% if initial_items and initial_items|length > 0 %}
          {% for car in initial_items %}
            <a class="car-card" href="/car/{{ car.id }}" data-id="{{ car.id }}">
              <div class="thumb-wrap">
                <img
                  class="thumb"
                  src="{{ car.thumbnail_url or '/static/img/no-photo.svg' }}"
                  loading="lazy"
                  decoding="async"
                  referrerpolicy="no-referrer"
                  {% if loop.index0 < 2 %}fetchpriority="high"{% endif %}
                  alt=""
                  data-thumb="{{ car.thumbnail_url or '/static/img/no-photo.svg' }}"
                  data-id="{{ car.id }}"
                  onerror="this.onerror=null;this.src='/static/img/no-photo.svg';"
                  width="320"
                  height="200"
                />
              </div>
              <div class="car-card__body">
                <div>
                  <div class="car-card__title">{{ car.brand or '' }} {{ car.model or '' }}</div>
                  {% set meta = [] %}
                  {% if car.year %}{% set _ = meta.append(car.year) %}{% endif %}
                  {% if car.engine_type %}{% set _ = meta.append(car.engine_type) %}{% endif %}
                  {% if meta %}
                    <div class="car-card__meta">{{ meta|join(' · ') }}</div>
                  {% endif %}
                  <ul class="specs">
                    {% if car.mileage %}
                      <li><span class="spec-line"><img class="spec-icon" src="/static/img/icons/mileage.svg" alt=""> {{ '{:,.0f}'.format(car.mileage).replace(',', ' ') }} км</span></li>
                    {% endif %}
                    {% if car.power_hp %}
                      <li><span class="spec-line">Мощность: {{ car.power_hp|round(0) }} л.с.</span></li>
                    {% endif %}
                    {% if car.engine_cc %}
                      <li><span class="spec-line">Объём: {{ '{:,.0f}'.format(car.engine_cc).replace(',', ' ') }} см³</span></li>
                    {% endif %}
                    {% if car.transmission %}
                      <li><span class="spec-line"><img class="spec-icon" src="/static/img/icons/drive.svg" alt=""> {{ car.transmission }}</span></li>
                    {% endif %}
                    {% if car.body_type %}
                      <li><span class="spec-line">{{ car.body_type }}</span></li>
                    {% endif %}
                    {% if car.color %}
                      <li><span class="spec-line"><img class="spec-icon" src="/static/img/icons/color.svg" alt=""> {{ car.color }}</span></li>
                    {% endif %}
                    {% if car.country %}
                      <li><span class="spec-line"><img class="spec-icon" src="/static/img/icons/flag.svg" alt=""> {{ country_labels.get(car.country, car.country) }}</span></li>
                    {% endif %}
                  </ul>
                </div>
                <div class="car-card__price">
                  {% set price_val = car.total_price_rub_cached or car.price_rub_cached %}
                  {% if price_val %}
                    <div class="price-main">{{ '{:,.0f}'.format(price_val).replace(',', ' ') }} ₽</div>
                  {% else %}
                    <div class="price-main">—</div>
                  {% endif %}
                </div>
              </div>
            </a>
          {% endfor %}
        {% endif %}
      </div>
      <div class="pagination">
        <button class="btn" id="prevPage">‹</button>
        <div id="pageNumbers" class="page-numbers"></div>
        <button class="btn" id="nextPage">›</button>
      </div>
      <div id="pageInfo" class="muted"></div>
    </div>
  </div>
</section>
<script>
  window.CATALOG_API = "/api/cars";
  window.COUNTRY_LABELS = {{ country_labels | tojson }};
</script>
{% endblock %}
