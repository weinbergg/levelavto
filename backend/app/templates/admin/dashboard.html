{% extends "base.html" %} {% block title %}Админка{% endblock %} {% block
content %}
<section class="section">
  <div class="la-container">
    <div class="section-header">
      <div>
        <h1 class="section-title" style="margin: 0">Администрирование</h1>
        <p class="section-sub">
          Редактирование текстов и витрины. Всего авто: {{ total_cars }}
        </p>
      </div>
    </div>

    <style>
      .admin-block { margin-bottom: 24px; padding: 16px; border-radius: 12px; background: #11151e; border: 1px solid #1c2330; }
      .admin-grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
      .form-inline { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
      .admin-quicklist__items { display: flex; flex-wrap: wrap; gap: 8px; max-height: 260px; overflow-y: auto; }
      .admin-quicklist { margin-top: 10px; }
      .text-input { padding: 8px 10px; border-radius: 8px; border: 1px solid #2a3242; background: #0c1018; color: #fff; }
      .btn { white-space: nowrap; }
      .current-featured { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
      .chip-selected { padding: 6px 10px; background: #1f2633; border-radius: 10px; border: 1px solid #2f3848; }
      .suggest-box { position: relative; max-width: 340px; }
      .suggest-list { position: absolute; z-index: 5; left: 0; right: 0; background: #0f141d; border: 1px solid #2a3242; border-radius: 10px; max-height: 240px; overflow-y: auto; margin-top: 4px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
      .suggest-item { padding: 8px 10px; cursor: pointer; }
      .suggest-item:hover { background: #1b2230; }
    </style>

    <div class="admin-block">
      <h3>Тексты на главной</h3>
      <form method="post" action="/admin/content" class="form-vertical">
        <label
          >Заголовок
          <input
            type="text"
            name="hero_title"
            value="{{ content.get('hero_title','Импорт и подбор автомобилей из Европы, Кореи и России') }}"
          />
        </label>
        <label
          >Подзаголовок
          <textarea name="hero_subtitle" rows="2">
{{ content.get('hero_subtitle','Актуальные предложения от проверенных партнёров — в одном каталоге.') }}</textarea
          >
        </label>
        <label
          >Примечание
          <textarea name="hero_note" rows="2">
{{ content.get('hero_note','Возим проверенные авто из Европы, Кореи и РФ. Минимальная предоплата — основная часть по факту поставки.') }}</textarea
          >
        </label>
        <label
          >email для заявок
          <input
            type="email"
            name="lead_email"
            value="{{ content.get('lead_email','info@levelavto.ru') }}"
          />
          <span class="small muted">Сюда будут уходить заявки с формы</span>
        </label>
        <div class="admin-grid-2">
          <label
            >Телефон
            <input
              type="text"
              name="contact_phone"
              placeholder="+7 (911) 070-75-00"
              value="{{ content.get('contact_phone','+7 (911) 070-75-00') }}"
            />
          </label>
          <label
            >Email
            <input
              type="email"
              name="contact_email"
              placeholder="info@levelavto.ru"
              value="{{ content.get('contact_email','info@levelavto.ru') }}"
            />
          </label>
          <label
            >Адрес
            <input
              type="text"
              name="contact_address"
              placeholder="Шелепихинская наб. 34к4, Москва"
              value="{{ content.get('contact_address','Шелепихинская набережная, 34к4 стр.8, Москва') }}"
            />
          </label>
          <label
            >Telegram (ссылка)
            <input
              type="text"
              name="contact_tg"
              placeholder="https://t.me/levelavto"
              value="{{ content.get('contact_tg','') }}"
            />
          </label>
          <label
            >WhatsApp (ссылка)
            <input
              type="text"
              name="contact_wa"
              placeholder="https://wa.me/79110707500"
              value="{{ content.get('contact_wa','') }}"
            />
          </label>
          <label
            >Instagram (ссылка)
            <input
              type="text"
              name="contact_ig"
              placeholder="https://instagram.com/..."
              value="{{ content.get('contact_ig','') }}"
            />
          </label>
        </div>
        <button type="submit" class="btn btn-primary">Сохранить тексты</button>
      </form>
    </div>

    <div class="admin-block">
      <h3>Рекомендуемые авто (единый список)</h3>
      <p class="hero-note">
        Минимум 4 авто. Порядок — слева направо на сайте. Добавляйте по ID или через поиск.
      </p>
      {% set selected_ids = featured | map(attribute='id') | list %}
      <form method="post" action="/admin/featured" class="form-inline" id="featuredForm">
        <input type="hidden" name="placement" value="recommended" />
        <label style="min-width: 180px">ID через запятую</label>
        <input
          type="text"
          name="car_ids"
          id="featuredInput"
          value="{{ selected_ids | join(', ') }}"
          placeholder="например: 123, 456, 789"
          class="text-input"
          style="min-width:280px;"
        />
        <button type="submit" class="btn btn-secondary">Сохранить</button>
        <span class="small muted" style="margin-left:8px;">Сейчас выбрано: {{ selected_ids|length }}</span>
      </form>
      <div class="admin-quicklist" style="margin-top:12px;">
        <div class="small muted" style="margin-bottom: 6px">Быстрый поиск (бренд/модель/ID):</div>
        <div class="suggest-box">
          <input type="text" id="featuredSearch" placeholder="BMW, Q7 или ID" class="text-input" style="width:100%;" autocomplete="off" />
          <div id="suggestList" class="suggest-list" style="display:none;"></div>
        </div>
        <div class="small muted" style="margin:10px 0 6px;">
          Последние с фото (до 40):
        </div>
        <div class="admin-quicklist__items">
          {% for car in recent_cars %}
          <button
            type="button"
            class="btn btn-secondary btn-small admin-quicklist__item"
            data-car-id="{{ car.id }}"
            data-title="{{ (car.brand or '') ~ ' ' ~ (car.model or '') ~ ' ' ~ (car.year or '') }}"
          >
            #{{ car.id }} {{ car.brand or '' }} {{ car.model or '' }} {{ car.year or '' }}
          </button>
          {% endfor %}
        </div>
      </div>
      {% if featured_cards %}
      <div class="admin-quicklist" style="margin-top:12px;">
        <div class="small muted">Текущий порядок:</div>
        <div class="current-featured">
          {% for card in featured_cards %}
          <span class="chip-selected">{{ card.title }} (#{{ card.id }})</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</section>
<script>
  (function() {
    const input = document.querySelector('#featuredInput');
    const search = document.querySelector('#featuredSearch');
    const suggestBox = document.querySelector('#suggestList');

    function addId(id) {
      if (!input) return;
      const current = input.value.split(',').map(x => x.trim()).filter(Boolean);
      if (!current.includes(String(id))) {
        current.push(String(id));
        input.value = current.join(', ');
      }
    }

    document.querySelectorAll(".admin-quicklist__item").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.carId;
        addId(id);
      });
    });

    let debounce;
    async function searchSuggest(q) {
      if (!q) { suggestBox.style.display = 'none'; suggestBox.innerHTML=''; return; }
      const res = await fetch(`/admin/featured/search?q=${encodeURIComponent(q)}`);
      if (!res.ok) return;
      const data = await res.json();
      if (!Array.isArray(data) || !data.length) { suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
      suggestBox.innerHTML = data
        .sort((a,b) => (a.title||'').localeCompare(b.title||''))
        .map(item => `<div class="suggest-item" data-id="${item.id}">${item.title} (#${item.id})</div>`)
        .join('');
      suggestBox.style.display = 'block';
      suggestBox.querySelectorAll('.suggest-item').forEach((el) => {
        el.addEventListener('click', () => {
          addId(el.dataset.id);
          suggestBox.style.display = 'none';
          suggestBox.innerHTML = '';
          search.value = '';
        });
      });
    }

    search?.addEventListener('input', (e) => {
      clearTimeout(debounce);
      const q = e.target.value.trim();
      debounce = setTimeout(() => searchSuggest(q), 200);
    });

    document.addEventListener('click', (e) => {
      if (!suggestBox.contains(e.target) && e.target !== search) {
        suggestBox.style.display = 'none';
      }
    });
  })();
</script>
{% endblock %}
