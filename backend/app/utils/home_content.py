from __future__ import annotations

import json
from copy import deepcopy
from typing import Any, Dict


DEFAULT_HOME_CONTENT: Dict[str, Any] = {
    "search": {
        "title": "Найти машину",
        "subtitle_suffix": "актуальных объявлений",
        "submit_label": "Найти",
        "submit_suffix": "объявлений",
        "reset_label": "Сбросить",
        "catalog_label": "Расширенный поиск",
    },
    "hero": {
        "stats_suffix": "авто в наличии",
        "title": "Импорт и подбор автомобилей из Европы и Кореи",
        "subtitle": "Актуальные предложения от проверенных европейских и локальных партнёров — в одном каталоге.",
        "note": "Возим проверенные авто из Европы, Кореи и РФ. Минимальная предоплата — основная часть по факту поставки.",
        "benefits": [
            "Любые формы оплаты",
            "Срок поставки от 30 дней",
            "Лизинг, кредит, НДС",
        ],
        "actions": {
            "primary_label": "Привезённые авто",
            "secondary_label": "Заявка на расчёт",
        },
        "why_title": "Почему мы",
        "why_items": [
            "Доступ к объявлениям проверенных площадок",
            "Проверка истории, диагностика и фотоотчёт перед оплатой",
            "Логистика, таможня и постановка на учёт под ключ",
            "Поддержка после выдачи: сервис, запчасти, страхование",
        ],
    },
    "cases": {
        "title": "За 8 лет привезли более 1000 автомобилей под заказ из Европы",
        "subtitle": "Реальные кейсы клиентов",
    },
    "about": {
        "eyebrow": "О нас",
        "title": "Меня зовут Дмитрий, я руководитель компании Level Avto",
        "subtitle": "С 2017г. профессионально занимаемся доставкой авто из-за границы.",
        "cards": [
            {
                "title": "Почему именно мы привезем Вам авто под заказ?",
                "items": [
                    "Большинство завершенных объявлений в Авито привезены из Европы и Кореи",
                    "В Instagram и Telegram — фото и видео отчёты сотен машин",
                    "Мы на Яндекс Картах: “Level Avto”, Шелепихинская наб., 34к4зд8, Москва",
                ],
            },
            {
                "title": "Как мы работаем",
                "items": [
                    "Оплата после получения авто с предоплатой от 10%",
                    "Оплата через СБЕР (ячейка) или поэтапно: инвойс, логистика, таможня",
                    "Фиксируем в договоре стоимость под ключ и сроки поставки",
                    "Любые формы оплаты: нал/безнал/кредит/лизинг/НДС",
                    "Партнёры: Европлан, Газпромбанк лизинг, Carcade, Совкомбанк лизинг, Балтийский лизинг",
                ],
            },
            {
                "title": "Ваши преимущества",
                "items": [
                    "Экономия 20–30% от рынка РФ",
                    "100% оригинальный пробег, история обслуживания и качественное ТО",
                    "Отличное ЛКП (без реагентов), качественная сборка, больше цветов и комплектаций",
                    "Новый авто любой марки — соберём на конфигураторе дилера",
                    "Доставка в любой регион РФ",
                ],
            },
            {
                "title": "Сроки доставки",
                "items": [
                    "Европа: 10–45 дней (10 дней если объём двигателя до 1.9л)",
                    "Корея: 30–45 дней",
                    "Китай: 30–60 дней",
                    "ОАЭ: 30–45 дней",
                ],
                "paragraph": "Поможем без посредников организовать покупку авто с пробегом или нового: диагностика, оплата, таможенная очистка, доставка, СБКТС и ЭлПТС, льготный утиль при возможности.",
                "emphasis": "Напишите или позвоните — сделаем бесплатный подбор и расчёт автомобиля вашей мечты.",
            },
        ],
    },
    "recommended": {
        "title": "Рекомендуем",
        "subtitle": "Отобранные предложения",
        "badge_label": "Рекомендуем",
        "empty_note": "Подборка появится автоматически при наличии подходящих авто.",
    },
    "vehicle_types": {
        "title": "Типы кузова",
        "subtitle": "Быстрый переход по кузовам",
        "empty_note": "Добавьте автомобили, чтобы показать статистику по кузовам.",
    },
    "advantages": {
        "title": "Преимущества Level Avto",
        "subtitle": "Сопровождаем подбор и поставку от поиска до выдачи",
        "cards": [
            {
                "title": "Честные источники",
                "text": "Собственный подбор, проверка, диагностика, логистика и выдача.",
            },
            {
                "title": "Финансовая гибкость",
                "text": "10% предоплата, помощь с лизингом, кредитом и НДС для бизнеса.",
            },
            {
                "title": "Под ключ",
                "text": "Проверка истории, диагностика, логистика, таможня и постановка на учёт.",
            },
        ],
    },
    "brands": {
        "title": "Популярные марки",
        "subtitle": "Показываем только бренды, которые есть в каталоге",
        "empty_note": "Добавьте логотипы в static/img/brand-logos, чтобы они появились.",
    },
    "how_it_works": {
        "title": "Как мы работаем",
        "subtitle": "Прозрачно сопровождаем на каждом этапе",
        "steps": [
            {
                "title": "Подбор",
                "text": "Уточняем бюджет и критерии, подбираем 5–10 вариантов из Europe и партнерских площадок.",
            },
            {
                "title": "Проверка",
                "text": "Диагностика, проверка истории, фото- и видеоотчёт. Гарантируем отсутствие скрытых проблем.",
            },
            {
                "title": "Логистика",
                "text": "Организуем выкуп, доставку, таможенное оформление и постановку на учёт.",
            },
            {
                "title": "Выдача",
                "text": "Передаём автомобиль, помогаем с лизингом/кредитом, страховкой и сервисом.",
            },
        ],
    },
    "seo": {
        "title": "Привозим автомобили из Европы под ваши задачи",
        "paragraphs": [
            "Level Avto — команда, которая специализируется на поставке автомобилей из Германии, Нидерландов, Бельгии и других стран ЕС. Мы работаем с проверенными дилерами, проверяем историю и техническое состояние, чтобы вы получали только честные предложения.",
            "Собираем подбор под бюджет и цели: семейные универсалы, первые автомобили, премиальные модели, электрокары. Помогаем с лизингом, кредитом и возвратом НДС для бизнеса.",
            "Мы берем на себя логистику, таможенное оформление, регистрацию и выдачу в вашем городе. Минимальная предоплата — основная часть оплачивается по факту поставки. Оставьте заявку, и мы предложим варианты в течение 1–2 дней.",
        ],
    },
    "lead": {
        "title": "Заявка на расчёт",
        "subtitle": "Оставьте контакты — подберём предложения и озвучим бюджет",
        "submit_label": "Отправить заявку",
        "note": "Заполните форму — свяжемся в течение рабочего дня",
        "privacy_prefix": "Я согласен с",
        "privacy_link_text": "политикой конфиденциальности",
    },
    "contacts": {
        "title": "Свяжитесь с нами",
        "subtitle_suffix": "Ежедневно 9:00–21:00",
        "callback_label": "Обратный звонок",
        "hours_note": "Каждый день 9:00–21:00",
        "call_button": "Позвонить",
        "email_button": "Написать на email",
    },
}


def _merge_dict(base: Dict[str, Any], incoming: Dict[str, Any]) -> Dict[str, Any]:
    for key, val in incoming.items():
        if isinstance(val, dict) and isinstance(base.get(key), dict):
            _merge_dict(base[key], val)
        else:
            base[key] = val
    return base


def default_home_content() -> Dict[str, Any]:
    return deepcopy(DEFAULT_HOME_CONTENT)


def build_home_content(content_map: Dict[str, str]) -> Dict[str, Any]:
    base = default_home_content()
    raw = content_map.get("home_content")
    if raw:
        try:
            data = json.loads(raw)
            if isinstance(data, dict):
                _merge_dict(base, data)
        except Exception:
            pass
    hero_title = content_map.get("hero_title")
    hero_subtitle = content_map.get("hero_subtitle")
    hero_note = content_map.get("hero_note")
    if hero_title:
        base["hero"]["title"] = hero_title
    if hero_subtitle:
        base["hero"]["subtitle"] = hero_subtitle
    if hero_note:
        base["hero"]["note"] = hero_note
    catalog_label = base.get("search", {}).get("catalog_label", "").strip()
    if not catalog_label or catalog_label.lower() == "к каталогу":
        base["search"]["catalog_label"] = DEFAULT_HOME_CONTENT["search"]["catalog_label"]
    cases_title = base.get("cases", {}).get("title", "").strip()
    if not cases_title or cases_title.lower() == "кейсы клиентов":
        base["cases"]["title"] = DEFAULT_HOME_CONTENT["cases"]["title"]
    cases_subtitle = base.get("cases", {}).get("subtitle", "").strip()
    if not cases_subtitle:
        base["cases"]["subtitle"] = DEFAULT_HOME_CONTENT["cases"]["subtitle"]
    return base


def serialize_home_content(home_content: Dict[str, Any]) -> str:
    return json.dumps(home_content, ensure_ascii=False, indent=2)
